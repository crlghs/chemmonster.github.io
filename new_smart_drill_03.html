<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HKDSE Chemistry Smart Drill</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #334155; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Smooth fade for list items */
        .question-item { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Toggle Checkbox Style */
        .toggle-checkbox:checked {
            background-color: #2563eb; /* blue-600 */
            border-color: #2563eb;
            color: white;
        }
        .toggle-checkbox:checked + span {
            color: white;
        }
        
        /* Loading Dots Animation */
        .typing-indicator span {
            animation: blink 1.4s infinite both;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
        
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.3s; }
        .drop-zone.active { border-color: #3b82f6; background-color: #eff6ff; }
        
        /* Compact Year Grid Item */
        .year-grid-item:hover { background-color: #f1f5f9; }
        .year-grid-item:hover .year-text { color: #0f172a; }

        /* Sortable Header Styles */
        .sortable-header { cursor: pointer; user-select: none; transition: color 0.2s; }
        .sortable-header:hover { color: #1e293b; }
        .sort-icon { display: inline-block; width: 12px; height: 12px; margin-left: 4px; opacity: 0.5; }
        .sortable-header.active .sort-icon { opacity: 1; color: #2563eb; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-sm md:text-base">

    <!-- LEFT SIDEBAR -->
    <aside class="w-80 bg-white border-r border-slate-200 flex flex-col shadow-xl z-20 flex-shrink-0">
        
        <!-- Header -->
        <div class="px-5 py-4 border-b border-slate-100 bg-white relative flex items-center justify-between">
            <div>
                <h1 class="text-xl font-bold tracking-tight text-slate-800">Smart Drill ðŸ§ª</h1>
                <p class="text-slate-500 text-xs font-medium">Strategic Revision Tool</p>
            </div>
            
            <!-- Settings Button -->
            <button onclick="window.smartDrill.toggleSettings()" class="text-slate-400 hover:text-slate-700 transition p-1 rounded-full hover:bg-slate-100">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-5 py-4 space-y-5">
            
            <!-- Settings Panel (Hidden by default) -->
            <div id="settings-panel" class="hidden bg-slate-50 border border-slate-200 rounded-lg p-4 mb-2">
                <h3 class="text-xs font-bold text-slate-900 uppercase tracking-widest mb-2">AI Settings</h3>
                <div class="space-y-2">
                    <label class="block text-xs text-slate-500">Gemini API Key</label>
                    <input type="password" id="api-key-input" placeholder="Paste API Key here..." class="w-full text-sm p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    <button id="save-key-btn" class="w-full py-1.5 text-xs font-bold bg-slate-800 text-white rounded hover:bg-slate-700">Save Key</button>
                </div>
            </div>

            <!-- SECTION 1: Source Files -->
            <div>
                <h3 class="text-sm font-bold text-slate-800 mb-2">1. Source</h3>
                <div class="drop-zone rounded-lg p-4 text-center cursor-pointer group hover:bg-slate-50" id="drop-zone">
                    <div class="flex items-center justify-center gap-2 text-slate-400 group-hover:text-blue-500 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <span class="text-sm font-semibold">Drop PDF / CSV</span>
                    </div>
                    <input type="file" id="file-input" multiple accept=".pdf,.csv" class="hidden">
                </div>
                <div id="file-list" class="space-y-1 mt-2"></div>
            </div>

            <!-- FILTERS FORM -->
            <form id="filter-form" class="space-y-6">
                
                <!-- SECTION 2: Year Filter -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-slate-800">2. Years</h3>
                        <button type="button" id="toggle-all-years" class="text-xs font-bold text-blue-600 hover:text-blue-700 hover:underline">Toggle All</button>
                    </div>
                    <div class="grid grid-cols-3 gap-1" id="year-filters">
                        <!-- Injected via JS as 3-col grid -->
                    </div>
                </div>

                <!-- SECTION 3: Topic Filter -->
                <div class="flex-1 min-h-0 flex flex-col">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-slate-800">3. Topics</h3>
                        <button type="button" id="toggle-all-topics" class="text-xs font-bold text-blue-600 hover:text-blue-700 hover:underline">Toggle All</button>
                    </div>
                    <div class="space-y-0.5 overflow-y-auto pr-1 custom-scrollbar max-h-48" id="topic-filters">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- SECTION 4: Paper Filter -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-sm font-bold text-slate-800">4. Paper</h3>
                        <button type="button" id="toggle-all-papers" class="text-xs font-bold text-blue-600 hover:text-blue-700 hover:underline">Toggle All</button>
                    </div>
                    <div class="flex flex-wrap gap-x-6 gap-y-2">
                        <label class="flex items-center space-x-2 cursor-pointer py-1 hover:bg-slate-50 rounded px-2 transition group">
                            <input type="checkbox" value="1A" checked class="form-checkbox text-blue-600 rounded border-slate-300 paper-checkbox flex-shrink-0 w-4 h-4">
                            <span class="text-sm text-slate-600 font-medium group-hover:text-slate-900">1A</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer py-1 hover:bg-slate-50 rounded px-2 transition group">
                            <input type="checkbox" value="1B" checked class="form-checkbox text-blue-600 rounded border-slate-300 paper-checkbox flex-shrink-0 w-4 h-4">
                            <span class="text-sm text-slate-600 font-medium group-hover:text-slate-900">1B</span>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer py-1 hover:bg-slate-50 rounded px-2 transition group">
                            <input type="checkbox" value="2" checked class="form-checkbox text-blue-600 rounded border-slate-300 paper-checkbox flex-shrink-0 w-4 h-4">
                            <span class="text-sm text-slate-600 font-medium group-hover:text-slate-900">2</span>
                        </label>
                    </div>
                </div>

                <!-- SECTION 5: Accuracy Filter -->
                <div>
                    <h3 class="text-sm font-bold text-slate-800 mb-2">5. Accuracy</h3>
                    <div class="space-y-2">
                        <div class="relative">
                            <select id="score-select" class="w-full appearance-none bg-white border border-slate-200 text-slate-700 py-2.5 px-3 pr-8 rounded-lg text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm cursor-pointer hover:border-slate-300 transition-colors">
                                <option value="all">Show ALL questions</option>
                                <option value="traps">Distinction Traps (&lt;40%)</option>
                                <option value="standard">Standard Zone (40-60%)</option>
                                <option value="must-win">Must-win (&gt;60%)</option>
                                <option value="custom">Custom Range...</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                        
                        <!-- Custom Range Inputs (Hidden by default) -->
                        <div id="custom-score-inputs" class="hidden flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                            <div class="flex-1">
                                <label class="block text-[10px] text-slate-500 font-bold uppercase mb-1">Min %</label>
                                <input type="number" id="min-score-input" min="0" max="100" value="0" class="w-full p-1 text-sm border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none text-center">
                            </div>
                            <span class="text-slate-400 mt-4">-</span>
                            <div class="flex-1">
                                <label class="block text-[10px] text-slate-500 font-bold uppercase mb-1">Max %</label>
                                <input type="number" id="max-score-input" min="0" max="100" value="100" class="w-full p-1 text-sm border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none text-center">
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
        
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-screen relative bg-slate-50">
        
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 px-8 py-5 flex justify-between items-center shadow-sm z-10">
            <div>
                <h2 class="text-xl font-bold text-slate-800">Question Bank</h2>
                <div class="flex items-center gap-2 mt-1">
                     <span class="w-2.5 h-2.5 rounded-full bg-emerald-500"></span>
                     <p class="text-sm text-slate-500 font-medium" id="result-count">Loading...</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                 <div class="text-right hidden md:block">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Database</p>
                    <p class="text-xs font-semibold text-slate-600" id="db-version">v2.4 (Sortable)</p>
                 </div>
                 <button id="generate-quiz-btn" class="px-5 py-2.5 bg-slate-900 text-white rounded-lg shadow-lg hover:bg-slate-800 font-bold text-sm transition flex items-center gap-2 transform active:scale-95">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    Generate Quiz List
                </button>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6" id="main-scroll">
            
            <!-- List Header with Sort Controls -->
            <div class="grid grid-cols-12 gap-4 px-4 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-200 mb-2 sticky top-0 bg-slate-50 z-10">
                <div class="col-span-3 sm:col-span-2 sortable-header" data-sort="default" id="sort-year">
                    Year / Paper <span class="sort-icon">â–¼</span>
                </div>
                <div class="col-span-6 sm:col-span-5 sortable-header" data-sort="topic" id="sort-topic">
                    Topic <span class="sort-icon">â–¼</span>
                </div>
                <div class="col-span-3 sm:col-span-2 sortable-header" data-sort="score" id="sort-score">
                    Accuracy <span class="sort-icon">â–¼</span>
                </div>
                <div class="hidden sm:block col-span-3 text-right">Actions</div>
            </div>

            <!-- Questions List -->
            <div id="questions-container" class="space-y-3 pb-10">
                <!-- JS will inject List Items here -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden h-full flex flex-col items-center justify-center text-slate-400 mt-20">
                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-6">
                    <svg class="w-10 h-10 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 class="text-lg font-semibold text-slate-700">No questions found</h3>
                <p class="text-sm mt-1">Adjust your filters to see more results.</p>
                <button id="empty-reset-btn" class="mt-4 text-blue-600 font-bold text-sm hover:underline">Reset Filters</button>
            </div>
        </div>
    </main>

    <!-- AI MODAL (Structure kept for potential future use) -->
    <div id="ai-modal" class="fixed inset-0 bg-slate-900/50 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] flex flex-col transform transition-all scale-95 opacity-0" id="ai-modal-content">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-indigo-50 to-purple-50 rounded-t-xl">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">âœ¨</span>
                    <h3 class="text-lg font-bold text-slate-900" id="ai-modal-title">AI Tutor</h3>
                </div>
                <button onclick="window.smartDrill.closeAiModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 text-sm text-slate-700 leading-relaxed" id="ai-modal-body"></div>
            <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-xl flex justify-end">
                <button onclick="window.smartDrill.closeAiModal()" class="px-5 py-2.5 bg-white border border-slate-200 rounded-lg text-sm font-bold text-slate-700 hover:bg-slate-100 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- DATA & APP LOGIC -->
    <script>
        // --- 1. INITIAL DATA ---
        let initialDatabase = [
            // Ensure all 15 topics are present in the list on startup
            { year: 2017, topic_id: "1", topic_name: "Planet Earth", paper: "1A", question_number: "14", score: 97 },
            { year: 2017, topic_id: "2", topic_name: "Microscopic World I", paper: "1A", question_number: "1", score: 58 },
            { year: 2017, topic_id: "3", topic_name: "Metals", paper: "1A", question_number: "3", score: 43 },
            { year: 2017, topic_id: "4", topic_name: "Acids and Bases", paper: "1A", question_number: "2", score: 64 },
            { year: 2017, topic_id: "5", topic_name: "Fossil Fuels", paper: "1B", question_number: "13", score: 41 },
            { year: 2017, topic_id: "6", topic_name: "Microscopic World II", paper: "1B", question_number: "5", score: 57 },
            { year: 2017, topic_id: "7", topic_name: "Redox Reactions", paper: "1A", question_number: "4", score: 76 },
            { year: 2017, topic_id: "8", topic_name: "Chemical Reactions and Energy", paper: "1A", question_number: "7", score: 45 },
            { year: 2017, topic_id: "9", topic_name: "Rate of Reaction", paper: "1B", question_number: "Sample", score: 50 },
            { year: 2017, topic_id: "10", topic_name: "Chemical Equilibrium", paper: "1B", question_number: "Sample", score: 50 },
            { year: 2017, topic_id: "11", topic_name: "Chemistry of Carbon Compounds", paper: "1A", question_number: "5", score: 63 },
            { year: 2017, topic_id: "12", topic_name: "Patterns in the Chemical World", paper: "1B", question_number: "Sample", score: 50 },
            { year: 2017, topic_id: "13", topic_name: "Industrial Chemistry", paper: "2", question_number: "Sample", score: 50 },
            { year: 2017, topic_id: "14", topic_name: "Materials Chemistry", paper: "2", question_number: "Sample", score: 50 },
            { year: 2025, topic_id: "15", topic_name: "Analytical Chemistry", paper: "2", question_number: "3(b)(iii)", score: 54 },

            // Additional 2025 Data
            { year: 2025, topic_id: "2", topic_name: "Microscopic World I", paper: "1B", question_number: "3(b)(ii)", score: 38 },
            { year: 2025, topic_id: "15", topic_name: "Analytical Chemistry", paper: "2", question_number: "3(b)(iv)", score: 20 },
            { year: 2025, topic_id: "15", topic_name: "Analytical Chemistry", paper: "2", question_number: "3(c)(i)", score: 75 },
            { year: 2025, topic_id: "15", topic_name: "Analytical Chemistry", paper: "2", question_number: "3(c)(ii)", score: 54 },
            { year: 2025, topic_id: "15", topic_name: "Analytical Chemistry", paper: "2", question_number: "3(c)(iii)", score: 18 },
            { year: 2025, topic_id: "5", topic_name: "Fossil Fuels", paper: "1B", question_number: "4(a)", score: 84 },
            { year: 2025, topic_id: "5", topic_name: "Fossil Fuels", paper: "1B", question_number: "4(b)(i)", score: 66 },
            { year: 2025, topic_id: "5", topic_name: "Fossil Fuels", paper: "1B", question_number: "4(b)(ii)", score: 72 },
            { year: 2025, topic_id: "5", topic_name: "Fossil Fuels", paper: "1B", question_number: "4(c)", score: 69 },
            { year: 2025, topic_id: "4", topic_name: "Acids and Bases", paper: "1B", question_number: "5(a)", score: 66 },
            { year: 2025, topic_id: "4", topic_name: "Acids and Bases", paper: "1B", question_number: "5(b)(i)", score: 84 },
            { year: 2025, topic_id: "4", topic_name: "Acids and Bases", paper: "1B", question_number: "5(b)(ii)", score: 61 },
            { year: 2025, topic_id: "4", topic_name: "Acids and Bases", paper: "1B", question_number: "5(b)(iii)", score: 19 },
            { year: 2025, topic_id: "7", topic_name: "Redox Reactions", paper: "1B", question_number: "6(a)", score: 77 }
        ];

        initialDatabase = initialDatabase.map(d => ({
            ...d,
            topic_display: `${d.topic_id}. ${d.topic_name}`
        }));


        // --- 2. MAIN APP LOGIC ---

        class SmartDrill {
            constructor(data) {
                this.allData = data;
                this.fileRegistry = {}; 
                this.pageMaps = {};     
                
                this.filters = {
                    years: new Set(),
                    papers: new Set(['1A', '1B', '2']),
                    topics: new Set(),
                    minScore: 0,
                    maxScore: 100
                };
                
                this.currentSort = 'default'; 
                this.sortDirection = 'desc'; 

                this.apiKey = localStorage.getItem('gemini_api_key') || '';
                this.init();
            }

            init() {
                this.populateFilters();
                this.setupEventListeners();
                this.autoLoadCSV(); // IMPLEMENTED: Automatic fetch
                this.renderQuestions();
                this.setupSettings();
                console.log("Smart Drill Initialized");
            }

            // --- AUTOMATIC CSV LOAD ---
            async autoLoadCSV() {
                try {
                    // Browsers require a server for this to work (fetch api)
                    const response = await fetch('data.csv');
                    if (!response.ok) return; // Silent return if file not found
                    const text = await response.text();
                    const csvData = this.parseCSV(text);
                    if (csvData.length > 0) {
                        this.allData = csvData;
                        this.populateFilters();
                        this.renderQuestions();
                        document.getElementById('db-version').innerText = `vAuto (${csvData.length})`;
                    }
                } catch (err) {
                    console.log("Auto-load CSV disabled or file not found. Falling back to internal data.");
                }
            }

            parseCSV(csvText) {
                const lines = csvText.split(/\r?\n/);
                const newData = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const matches = line.match(/(?:,|^)(?:"([^"]*)"|([^",]*))/g);
                    if (!matches || matches.length < 6) continue;
                    const cols = matches.map(m => {
                        let val = m.startsWith(',') ? m.slice(1) : m;
                        if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                        return val.trim();
                    });
                    const year = parseInt(cols[0]);
                    const topicId = cols[1];
                    const topicName = cols[2];
                    const paper = cols[3];
                    const qNum = cols[4];
                    const scoreStr = cols[5] || "0";
                    const score = parseInt(scoreStr.replace('%', ''));
                    if (!isNaN(year)) {
                        newData.push({
                            year: year, paper: paper, question_number: qNum, score: score,
                            topic_id: topicId, topic_name: topicName, topic_display: `${topicId}. ${topicName}`
                        });
                    }
                }
                return newData;
            }

            setupSettings() {
                const keyInput = document.getElementById('api-key-input');
                const saveBtn = document.getElementById('save-key-btn');
                if (keyInput) keyInput.value = this.apiKey;
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => {
                        const key = keyInput.value.trim();
                        if(key) {
                            localStorage.setItem('gemini_api_key', key);
                            this.apiKey = key;
                            alert('API Key Saved!');
                            this.toggleSettings();
                        }
                    });
                }
            }

            toggleSettings() {
                const panel = document.getElementById('settings-panel');
                if (panel) panel.classList.toggle('hidden');
            }

            closeAiModal() {
                const modal = document.getElementById('ai-modal');
                const content = document.getElementById('ai-modal-content');
                if (content) content.classList.replace('opacity-100', 'opacity-0');
                setTimeout(() => { if (modal) modal.classList.add('hidden'); }, 200);
            }

            populateFilters() {
                const yearContainer = document.getElementById('year-filters');
                yearContainer.innerHTML = '';
                const years = [2025, 2024, 2023, 2022, 2021, 2020, 2019, 2018, 2017];
                const dataYears = [...new Set(this.allData.map(d => d.year))];
                dataYears.forEach(y => { if(!years.includes(y)) years.push(y); });
                years.sort((a, b) => b - a);

                years.forEach(year => {
                    this.filters.years.add(year);
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label class="flex items-center space-x-1 cursor-pointer py-1 hover:bg-slate-50 rounded px-1 transition group year-grid-item">
                            <input type="checkbox" value="${year}" checked class="form-checkbox text-blue-600 rounded border-slate-300 year-checkbox flex-shrink-0 w-3.5 h-3.5">
                            <span class="text-xs text-slate-500 font-medium group-hover:text-slate-900 year-text transition-colors">${year}</span>
                            <span id="icon-${year}" class="ml-auto text-[10px] text-blue-500 font-bold opacity-0 transition-opacity">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </span>
                        </label>`;
                    yearContainer.appendChild(div);
                });

                const topicContainer = document.getElementById('topic-filters');
                topicContainer.innerHTML = '';
                const topics = [...new Set(this.allData.map(d => d.topic_display))].sort((a, b) => {
                    const numA = parseInt(a.split('.')[0]) || 0;
                    const numB = parseInt(b.split('.')[0]) || 0;
                    return numA - numB;
                });
                topics.forEach(topic => {
                    this.filters.topics.add(topic);
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label class="flex items-center space-x-2 cursor-pointer py-1.5 hover:bg-slate-50 rounded px-2 transition group">
                            <input type="checkbox" value="${topic}" checked class="form-checkbox text-blue-600 rounded border-slate-300 topic-checkbox flex-shrink-0 w-4 h-4">
                            <span class="text-sm text-slate-600 truncate group-hover:text-slate-900" title="${topic}">${topic}</span>
                        </label>`;
                    topicContainer.appendChild(div);
                });
                this.setupEventListeners(); 
            }

            setupEventListeners() {
                if(this.eventsBound) return;
                
                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        const type = header.getAttribute('data-sort');
                        if (this.currentSort === type) {
                            this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            this.currentSort = type;
                            this.sortDirection = 'desc'; 
                            if (type === 'topic') this.sortDirection = 'asc';
                        }
                        
                        document.querySelectorAll('.sortable-header').forEach(h => {
                            h.classList.remove('active');
                            h.querySelector('.sort-icon').innerText = 'â–¼';
                        });
                        header.classList.add('active');
                        header.querySelector('.sort-icon').innerText = this.sortDirection === 'asc' ? 'â–²' : 'â–¼';
                        
                        this.renderQuestions();
                    });
                });

                document.getElementById('year-filters').addEventListener('change', (e) => {
                    if(e.target.classList.contains('year-checkbox')) {
                        const val = parseInt(e.target.value);
                        e.target.checked ? this.filters.years.add(val) : this.filters.years.delete(val);
                        this.renderQuestions();
                    }
                });

                document.getElementById('topic-filters').addEventListener('change', (e) => {
                    if(e.target.classList.contains('topic-checkbox')) {
                        const val = e.target.value;
                        e.target.checked ? this.filters.topics.add(val) : this.filters.topics.delete(val);
                        this.renderQuestions();
                    }
                });
                
                document.querySelectorAll('.paper-checkbox').forEach(cb => {
                    cb.addEventListener('change', (e) => {
                        e.target.checked ? this.filters.papers.add(e.target.value) : this.filters.papers.delete(e.target.value);
                        this.renderQuestions();
                    });
                });

                document.getElementById('score-select').addEventListener('change', (e) => {
                    const val = e.target.value;
                    const customInputs = document.getElementById('custom-score-inputs');
                    
                    if (val === 'traps') { 
                        this.filters.minScore = 0; this.filters.maxScore = 39; 
                        customInputs.classList.add('hidden');
                    }
                    else if (val === 'standard') { 
                        this.filters.minScore = 40; this.filters.maxScore = 60; 
                        customInputs.classList.add('hidden');
                    }
                    else if (val === 'must-win') { 
                        this.filters.minScore = 61; this.filters.maxScore = 100; 
                        customInputs.classList.add('hidden');
                    }
                    else if (val === 'custom') {
                        customInputs.classList.remove('hidden');
                        this.filters.minScore = parseInt(document.getElementById('min-score-input').value) || 0;
                        this.filters.maxScore = parseInt(document.getElementById('max-score-input').value) || 100;
                    }
                    else { 
                        this.filters.minScore = 0; this.filters.maxScore = 100; 
                        customInputs.classList.add('hidden');
                    }
                    this.renderQuestions();
                });

                const updateCustomRange = () => {
                    const minVal = parseInt(document.getElementById('min-score-input').value) || 0;
                    const maxVal = parseInt(document.getElementById('max-score-input').value) || 100;
                    this.filters.minScore = minVal;
                    this.filters.maxScore = maxVal;
                    this.renderQuestions();
                };

                document.getElementById('min-score-input').addEventListener('input', updateCustomRange);
                document.getElementById('max-score-input').addEventListener('input', updateCustomRange);

                document.getElementById('empty-reset-btn').addEventListener('click', () => {
                   this.filters.minScore = 0;
                   this.filters.maxScore = 100;
                   document.getElementById('score-select').value = "all";
                   document.getElementById('custom-score-inputs').classList.add('hidden');
                   document.querySelectorAll('.year-checkbox, .topic-checkbox, .paper-checkbox').forEach(cb => { cb.checked = true; });
                   this.populateFilters(); 
                   this.renderQuestions();
                });
                
                document.getElementById('toggle-all-topics').addEventListener('click', () => {
                    const cbs = document.querySelectorAll('.topic-checkbox');
                    const allChecked = Array.from(cbs).every(c => c.checked);
                    cbs.forEach(c => {
                         c.checked = !allChecked;
                         !allChecked ? this.filters.topics.add(c.value) : this.filters.topics.delete(c.value);
                    });
                    this.renderQuestions();
                });

                document.getElementById('toggle-all-years').addEventListener('click', () => {
                    const cbs = document.querySelectorAll('.year-checkbox');
                    const allChecked = Array.from(cbs).every(c => c.checked);
                    cbs.forEach(c => {
                         c.checked = !allChecked;
                         const val = parseInt(c.value);
                         !allChecked ? this.filters.years.add(val) : this.filters.years.delete(val);
                    });
                    this.renderQuestions();
                });

                document.getElementById('toggle-all-papers').addEventListener('click', () => {
                    const cbs = document.querySelectorAll('.paper-checkbox');
                    const allChecked = Array.from(cbs).every(c => c.checked);
                    cbs.forEach(c => {
                         c.checked = !allChecked;
                         const val = c.value;
                         !allChecked ? this.filters.papers.add(val) : this.filters.papers.delete(val);
                    });
                    this.renderQuestions();
                });

                document.getElementById('generate-quiz-btn').addEventListener('click', () => {
                    const filtered = this.getFilteredQuestions();
                    const printWindow = window.open('', '_blank');
                    const html = `
                        <html>
                        <head>
                            <title>Custom Quiz Checklist</title>
                            <style>
                                body { font-family: sans-serif; padding: 40px; }
                                h1 { margin-bottom: 5px; }
                                .summary { color: #666; margin-bottom: 20px; font-size: 14px; }
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th { text-align: left; background: #f3f4f6; padding: 10px; border-bottom: 2px solid #ddd; }
                                td { padding: 10px; border-bottom: 1px solid #eee; }
                                .score { font-weight: bold; }
                                .score-low { color: #e11d48; }
                                .score-med { color: #d97706; }
                                .score-high { color: #059669; }
                                @media print { button { display: none; } }
                            </style>
                        </head>
                        <body>
                            <h1>Chemistry Revision Checklist</h1>
                            <div class="summary">
                                Generated on ${new Date().toLocaleDateString()} â€¢ ${filtered.length} Questions Selected<br>
                                Filters: Accuracy ${this.filters.minScore}% - ${this.filters.maxScore}%
                            </div>
                            <button onclick="window.print()" style="padding: 10px 20px; cursor: pointer; margin-bottom: 20px;">Print Checklist</button>
                            <table>
                                <thead><tr><th>Year</th><th>Paper</th><th>Q#</th><th>Topic</th><th>Accuracy</th><th>Check</th></tr></thead>
                                <tbody>
                                    ${filtered.map(q => {
                                        let colorClass = q.score < 50 ? 'score-low' : (q.score < 75 ? 'score-med' : 'score-high');
                                        return `<tr>
                                            <td>${q.year}</td>
                                            <td>${q.paper}</td>
                                            <td>${q.question_number}</td>
                                            <td>${q.topic_display}</td>
                                            <td class="score ${colorClass}">${q.score}%</td>
                                            <td><input type="checkbox"></td>
                                        </tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </body>
                        </html>
                    `;
                    printWindow.document.write(html);
                    printWindow.document.close();
                });

                const dropZone = document.getElementById('drop-zone');
                const fileInput = document.getElementById('file-input');
                dropZone.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('active'); });
                dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('active'); });
                dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('active'); this.handleFiles(e.dataTransfer.files); });
                
                this.eventsBound = true;
            }

            getFilteredQuestions() {
                let filtered = this.allData.filter(q => 
                    this.filters.years.has(q.year) &&
                    this.filters.papers.has(q.paper) &&
                    this.filters.topics.has(q.topic_display) &&
                    q.score >= this.filters.minScore && q.score <= this.filters.maxScore
                );

                if (this.currentSort === 'default') {
                    filtered.sort((a, b) => {
                        if (a.year !== b.year) return this.sortDirection === 'asc' ? a.year - b.year : b.year - a.year;
                        if (a.paper !== b.paper) return a.paper.localeCompare(b.paper);
                        
                        const qStrA = (a.question_number || "").toString();
                        const qStrB = (b.question_number || "").toString();
                        const matchA = qStrA.match(/\d+/);
                        const matchB = qStrB.match(/\d+/);
                        const qA = matchA ? parseInt(matchA[0]) : 0;
                        const qB = matchB ? parseInt(matchB[0]) : 0;
                        return qA - qB;
                    });
                } else if (this.currentSort === 'topic') {
                    filtered.sort((a, b) => {
                        const tA = parseInt((a.topic_display || "0").split('.')[0]) || 0;
                        const tB = parseInt((b.topic_display || "0").split('.')[0]) || 0;
                        return this.sortDirection === 'asc' ? tA - tB : tB - tA;
                    });
                } else if (this.currentSort === 'score') {
                    filtered.sort((a, b) => this.sortDirection === 'asc' ? (a.score || 0) - (b.score || 0) : (b.score || 0) - (a.score || 0));
                }

                return filtered;
            }

            renderQuestions() {
                const container = document.getElementById('questions-container');
                const filtered = this.getFilteredQuestions();

                document.getElementById('result-count').innerText = `Showing ${filtered.length} questions`;
                container.innerHTML = '';
                
                if (filtered.length === 0) {
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }
                document.getElementById('empty-state').classList.add('hidden');

                filtered.forEach(q => {
                    const fileKey = `${q.year}_${q.paper}`;
                    const hasFile = !!this.fileRegistry[fileKey];
                    const item = document.createElement('div');
                    item.className = "bg-white p-3 rounded-lg border border-slate-200 hover:border-blue-300 hover:shadow-sm transition question-item flex flex-col sm:flex-row items-center justify-between gap-3";
                    
                    let scoreBadgeColor = (q.score || 0) < 50 ? 'bg-rose-200 text-rose-800 border-rose-300' : ((q.score || 0) < 75 ? 'bg-amber-200 text-amber-800 border-amber-300' : 'bg-emerald-200 text-emerald-800 border-emerald-300');

                    item.innerHTML = `
                        <div class="flex-1 w-full grid grid-cols-12 gap-4 items-center">
                            <div class="col-span-3 sm:col-span-2">
                                <div class="flex flex-col">
                                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wide">${q.year} â€¢ ${q.paper}</span>
                                    <span class="text-lg font-bold text-slate-800">Q${q.question_number}</span>
                                </div>
                            </div>
                            <div class="col-span-9 sm:col-span-5">
                                <span class="text-sm font-medium text-slate-700 line-clamp-2" title="${q.topic_display}">${q.topic_display}</span>
                            </div>
                            <div class="col-span-3 sm:col-span-2">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-black border shadow-sm ${scoreBadgeColor}">
                                    ${q.score}%
                                </span>
                            </div>
                            <div class="col-span-9 sm:col-span-3 flex justify-end gap-2">
                                <button onclick="window.smartDrill.viewQuestion('${q.year}', '${q.paper}', '${q.question_number}')" 
                                    class="px-3 py-1.5 rounded-md text-xs font-bold transition flex items-center gap-1 ${hasFile ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-sm' : 'bg-slate-100 text-slate-400 cursor-not-allowed'}" ${!hasFile ? 'disabled' : ''}>
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    View
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });
            }

            async handleFiles(files) {
                const listContainer = document.getElementById('file-list');
                for (let file of files) {
                    if (file.name.endsWith('.csv') || file.type === 'text/csv') {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const csvData = this.parseCSV(e.target.result);
                            if (csvData.length > 0) {
                                this.allData = csvData;
                                this.populateFilters();
                                this.renderQuestions();
                                document.getElementById('db-version').innerText = `vCustom (${csvData.length})`;
                                listContainer.innerHTML += `<div class="flex justify-between items-center bg-purple-50 text-purple-700 px-3 py-2 rounded text-xs border border-purple-100 mb-1"><span>ðŸ“Š CSV Loaded</span><span>âœ“</span></div>`;
                            }
                        };
                        reader.readAsText(file);
                        continue;
                    }
                    if (file.type !== 'application/pdf') continue;
                    const yearMatch = file.name.match(/20\d{2}/);
                    
                    if (yearMatch) {
                        const year = yearMatch[0];
                        let paper = "1A"; 
                        const nameUpper = file.name.toUpperCase();

                        if (nameUpper.includes("1B")) paper = "1B";
                        else if (nameUpper.includes("PAPER 2") || nameUpper.includes("PAPER2") || nameUpper.includes("P2") || nameUpper.match(/[\W_]2[\W.]/) || nameUpper.match(/[(]2[)]/)) paper = "2";
                        else if (nameUpper.includes("1A")) paper = "1A";

                        const key = `${year}_${paper}`;
                        const url = URL.createObjectURL(file);
                        this.fileRegistry[key] = { file, url };
                        
                        const badgeId = `badge-${key}`;
                        if(!document.getElementById(badgeId)) {
                            listContainer.innerHTML += `<div id="${badgeId}" class="flex justify-between items-center bg-blue-50 text-blue-700 px-3 py-2 rounded text-xs border border-blue-100 mb-1 animate-pulse"><span>ðŸ“„ ${year} Paper ${paper}</span><span id="status-${key}">Scanning...</span></div>`;
                        }

                        const yearCb = document.querySelector(`.year-checkbox[value="${year}"]`);
                        if(yearCb) {
                            yearCb.checked = true;
                            this.filters.years.add(parseInt(year));
                            const icon = document.getElementById(`icon-${year}`);
                            if(icon) icon.classList.remove('opacity-0');
                        }

                        await this.scanPDF(url, key, badgeId);
                    }
                }
                this.renderQuestions();
            }

            async scanPDF(url, fileKey, badgeId) {
                try {
                    const loadingTask = pdfjsLib.getDocument(url);
                    const pdf = await loadingTask.promise;
                    const map = {};
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        const text = textContent.items.map(s => s.str).join(' ');
                        const matches = [...text.matchAll(/(?:^|\s)Q\s?(\d+)[\.\s]/gi)];
                        matches.forEach(m => { if(!map[m[1]]) map[m[1]] = pageNum; });
                    }
                    this.pageMaps[fileKey] = map;
                    const badge = document.getElementById(badgeId);
                    if(badge) {
                        badge.className = "flex justify-between items-center bg-emerald-50 text-emerald-700 px-3 py-2 rounded text-xs border border-emerald-100 mb-1";
                        badge.querySelector(`#status-${fileKey}`).innerText = "âœ“ Ready";
                    }
                } catch (error) { console.error("PDF Scan Error", error); }
            }

            viewQuestion(year, paper, questionNum) {
                const key = `${year}_${paper}`;
                if (!this.fileRegistry[key]) return;
                
                const qStr = (questionNum || "").toString();
                const match = qStr.match(/\d+/);
                const mainQ = match ? match[0] : '1'; 
                let page = this.pageMaps[key]?.[mainQ] || 1;
                const searchTerm = match ? `Q${mainQ}` : qStr; 
                window.open(`${this.fileRegistry[key].url}#page=${page}&search=${searchTerm}`, '_blank');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.smartDrill = new SmartDrill(initialDatabase);
        });
    </script>
</body>
</html>