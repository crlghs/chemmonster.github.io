<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoltaicLab: HKDSE Redox Explorer</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* LCD Screen Glow Effect */
        .lcd-screen {
            background: linear-gradient(135deg, #1a2e1a 0%, #2a402a 100%);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
            text-shadow: 0 0 5px rgba(50, 255, 50, 0.7);
        }

        /* Metal Texture Animation */
        .metal-oxidized {
            background: linear-gradient(45deg, #718096, #4a5568);
            opacity: 0.8;
            border-style: dashed;
        }
        .metal-shiny {
            background: linear-gradient(135deg, #e2e8f0 0%, #ffffff 50%, #cbd5e0 100%);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.6);
            border-style: solid;
            transition: all 0.5s ease;
        }
        
        /* Quiz Slots */
        .quiz-slot {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='8' ry='8' stroke='%23CBD5E0FF' stroke-width='2' stroke-dasharray='10%2c 10' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
        }

        /* Electron Animation */
        .electron-flow {
            stroke-dasharray: 10;
            animation: flow 1s linear infinite;
        }
        .electron-flow-reverse {
            stroke-dasharray: 10;
            animation: flow-reverse 1s linear infinite;
        }

        @keyframes flow {
            to { stroke-dashoffset: -20; }
        }
        @keyframes flow-reverse {
            to { stroke-dashoffset: 20; }
        }
        
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 select-none">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect } = React;

        // --- CONSTANTS & DATA ---
        const METALS_DATA = {
            W: { id: 'W', symbol: 'Zn', name: 'Zinc', potential: 0.00, color: 'bg-zinc-400' },
            X: { id: 'X', symbol: 'Mg', name: 'Magnesium', potential: -0.74, color: 'bg-slate-300' },
            Y: { id: 'Y', symbol: 'Cu', name: 'Copper', potential: +0.89, color: 'bg-orange-300' },
            Z: { id: 'Z', symbol: 'Sn', name: 'Tin', potential: +0.40, color: 'bg-gray-300' }
        };

        const FREE_PLAY_METALS = [
            { id: 'Mg', name: 'Magnesium', E: -2.38, color: 'bg-slate-300' },
            { id: 'Zn', name: 'Zinc', E: -0.76, color: 'bg-zinc-400' },
            { id: 'Fe', name: 'Iron', E: -0.44, color: 'bg-stone-500' },
            { id: 'Pb', name: 'Lead', E: -0.13, color: 'bg-gray-500' },
            { id: 'Cu', name: 'Copper', E: +0.34, color: 'bg-orange-300' },
            { id: 'Ag', name: 'Silver', E: +0.80, color: 'bg-slate-100' }
        ];

        // Correct order: Lowest potential (Anode) -> Highest potential (Cathode)
        const CORRECT_ORDER = ['X', 'W', 'Z', 'Y'];

        // --- COMPONENTS ---

        const App = () => {
            const [mode, setMode] = useState('FREEPLAY');
            // Separate states for separate modes
            const [experimentRecords, setExperimentRecords] = useState([]);
            const [consolidationRecords, setConsolidationRecords] = useState([]);
            
            const addExperimentRecord = (record) => {
                const lastRecord = experimentRecords[experimentRecords.length - 1];
                if (lastRecord && 
                    lastRecord.red === record.red && 
                    lastRecord.black === record.black && 
                    lastRecord.voltage === record.voltage) {
                    return; 
                }
                setExperimentRecords([...experimentRecords, record]);
            };

            const addConsolidationRecord = (record) => {
                const lastRecord = consolidationRecords[consolidationRecords.length - 1];
                if (lastRecord && 
                    lastRecord.red === record.red && 
                    lastRecord.black === record.black && 
                    lastRecord.voltage === record.voltage) {
                    return; 
                }
                setConsolidationRecords([...consolidationRecords, record]);
            };

            const clearExperimentRecords = () => {
                setExperimentRecords([]);
            };

            const clearConsolidationRecords = () => {
                setConsolidationRecords([]);
            };

            return (
                <div className="flex flex-col h-screen max-w-4xl mx-auto bg-white shadow-2xl overflow-hidden relative">
                    <header className="bg-slate-800 text-white p-4 flex justify-between items-center z-10 shadow-md">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center font-bold">V</div>
                            <h1 className="font-bold text-lg hidden sm:block">VoltaicLab: <span className="text-blue-300 font-normal">Redox Explorer</span></h1>
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                            <NavButton label="Free-Play" active={mode === 'FREEPLAY'} onClick={() => setMode('FREEPLAY')} />
                            <NavButton label="Experiment" active={mode === 'LAB'} onClick={() => setMode('LAB')} />
                            <NavButton label="Quiz" active={mode === 'QUIZ'} onClick={() => setMode('QUIZ')} />
                            <NavButton label="Consolidation" active={mode === 'CONSOLIDATION'} onClick={() => setMode('CONSOLIDATION')} />
                        </div>
                    </header>
                    <main className="flex-1 relative bg-slate-50 overflow-y-auto">
                        {mode === 'LAB' ? 
                            <LabBench 
                                addRecord={addExperimentRecord} 
                                records={experimentRecords} 
                                clearRecords={clearExperimentRecords} 
                            /> : 
                         mode === 'FREEPLAY' ? 
                            <FreePlayMode /> : 
                         mode === 'QUIZ' ?
                            <QuizMode records={experimentRecords} /> :
                            <ConsolidationMode 
                                addRecord={addConsolidationRecord} 
                                records={consolidationRecords} 
                                clearRecords={clearConsolidationRecords} 
                            />
                        }
                    </main>
                </div>
            );
        };

        const NavButton = ({ label, active, onClick }) => (
            <button 
                onClick={onClick} 
                className={`px-3 sm:px-4 py-1.5 rounded-full text-xs sm:text-sm font-semibold whitespace-nowrap transition-all duration-200 flex-shrink-0
                ${active ? 'bg-blue-500 text-white shadow-lg scale-105' : 'bg-slate-700 text-slate-300 hover:bg-slate-600 hover:text-white'}`}
            >
                {label}
            </button>
        );

        // --- NEW FINDINGS COMPONENTS ---
        const FindingsTable = ({ records }) => {
            if (records.length === 0) {
                return <div className="p-6 text-center text-slate-400 text-xs italic">No data recorded yet.</div>;
            }
            return (
                <table className="w-full text-xs sm:text-sm text-left">
                    <thead className="text-[10px] sm:text-xs text-slate-500 uppercase bg-slate-50 sticky top-0">
                        <tr>
                            <th className="px-3 py-2">Red (+)</th>
                            <th className="px-3 py-2">Black (-)</th>
                            <th className="px-3 py-2 text-right">Voltage</th>
                        </tr>
                    </thead>
                    <tbody>
                        {records.map((rec, idx) => (
                            <tr key={idx} className="border-b border-slate-100 hover:bg-slate-50">
                                <td className="px-3 py-2 font-bold text-red-600">{rec.red}</td>
                                <td className="px-3 py-2 font-bold text-slate-700">{rec.black}</td>
                                <td className="px-3 py-2 text-right font-mono font-bold">{rec.voltage} V</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            );
        };

        const FindingsPanel = ({ records, onClear }) => (
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-full">
                <div className="bg-slate-100 p-2 border-b border-slate-200 font-bold text-slate-700 text-xs flex items-center justify-between gap-2">
                    <div className="flex items-center gap-2">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                        Notebook
                    </div>
                    {onClear && (
                        <button 
                            onClick={onClear} 
                            className="text-slate-400 hover:text-red-500 transition-colors p-1"
                            title="Clear current data"
                        >
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    )}
                </div>
                <div className="overflow-y-auto flex-1 bg-slate-50">
                    <FindingsTable records={records} />
                </div>
            </div>
        );

        const ElectronParticle = ({ pathId, delay, reverse }) => {
            return (
                <g>
                    <circle r="5" fill="#3b82f6" stroke="white" strokeWidth="1.5" />
                    <text fill="white" y="3.5" textAnchor="middle" fontSize="10" fontWeight="900" style={{fontFamily: 'Arial'}}>-</text>
                    <animateMotion 
                        dur="2s" 
                        repeatCount="indefinite" 
                        begin={`${delay}s`} 
                        keyPoints={reverse ? "1;0" : "0;1"} 
                        keyTimes="0;1" 
                        calcMode="linear"
                    >
                        <mpath href={`#${pathId}`} />
                    </animateMotion>
                </g>
            );
        };

        const ConsolidationMode = ({ addRecord, records, clearRecords }) => {
            const METAL_IDS = ['Fo', 'Im', 'My', 'Od', 'Wd'];
            const [potentials, setPotentials] = useState({});
            const [redConn, setRedConn] = useState(null);
            const [blackConn, setBlackConn] = useState(null);
            const [voltage, setVoltage] = useState("0.00");
            const [placed, setPlaced] = useState([null, null, null, null, null]);
            const [available, setAvailable] = useState(METAL_IDS);
            const [result, setResult] = useState(null);
            const [isElectronVisible, setIsElectronVisible] = useState(false);
            
            // Wire logic
            const containerRef = useRef(null);
            const redTermRef = useRef(null);
            const blackTermRef = useRef(null);
            const metalRefs = useRef({});
            const [wireCoords, setWireCoords] = useState({ red: null, black: null });
            
            const generateProblem = () => {
                if (clearRecords) clearRecords();

                const newPots = {};
                const usedValues = new Set();
                METAL_IDS.forEach(id => {
                    let val;
                    do { val = (Math.random() * 4 - 2.5).toFixed(2); } while (usedValues.has(val));
                    usedValues.add(val);
                    newPots[id] = parseFloat(val);
                });
                setPotentials(newPots);
                setRedConn(null);
                setBlackConn(null);
                setVoltage("0.00");
                setPlaced([null, null, null, null, null]);
                setAvailable(METAL_IDS);
                setResult(null);
                setIsElectronVisible(false); // Reset visibility on new problem
            };

            useEffect(() => {
                if (Object.keys(potentials).length === 0) generateProblem();
            }, []);

            useEffect(() => {
                if (redConn && blackConn && redConn !== blackConn) {
                    const v = potentials[redConn] - potentials[blackConn];
                    setVoltage((v >= 0 ? "+" : "") + v.toFixed(2));
                } else {
                    setVoltage("0.00");
                }
            }, [redConn, blackConn, potentials]);

            // Wire Calculation
             useLayoutEffect(() => {
                const calculate = () => {
                    if (!containerRef.current) return;
                    const containerRect = containerRef.current.getBoundingClientRect();
                    const getCenter = (el) => {
                        if (!el) return { x: 0, y: 0 };
                        const rect = el.getBoundingClientRect();
                        return { x: rect.left + rect.width / 2 - containerRect.left, y: rect.top + rect.height / 2 - containerRect.top };
                    };

                    let newCoords = { red: null, black: null };

                    // Get Multimeter Terminals
                    const redStart = getCenter(redTermRef.current);
                    const blackStart = getCenter(blackTermRef.current);

                    // Get Metal Strip Tops
                    if (redConn && metalRefs.current[redConn]) {
                         const metalCenter = getCenter(metalRefs.current[redConn]);
                         // Connect to top of metal strip
                         newCoords.red = { start: redStart, end: { x: metalCenter.x, y: metalCenter.y - 40 } };
                    }
                    if (blackConn && metalRefs.current[blackConn]) {
                        const metalCenter = getCenter(metalRefs.current[blackConn]);
                        newCoords.black = { start: blackStart, end: { x: metalCenter.x, y: metalCenter.y - 40 } };
                    }

                    setWireCoords(newCoords);
                };
                
                calculate();
                window.addEventListener('resize', calculate);
                // Delay to ensure layout is settled
                setTimeout(calculate, 50);
                return () => window.removeEventListener('resize', calculate);
            }, [redConn, blackConn]);

            const handleConnect = (id) => {
                if (redConn === id) setRedConn(null);
                else if (blackConn === id) setBlackConn(null);
                else if (!redConn) setRedConn(id);
                else if (!blackConn) setBlackConn(id);
            };

            const handleRecord = () => {
                if (voltage === "0.00") return;
                addRecord({ red: redConn, black: blackConn, voltage: voltage });
            };

            const handlePlace = (id) => {
                const idx = placed.indexOf(null);
                if (idx === -1) return;
                const newPlaced = [...placed];
                newPlaced[idx] = id;
                setPlaced(newPlaced);
                setAvailable(available.filter(a => a !== id));
                setResult(null);
            };

            const handleRemove = (idx) => {
                const id = placed[idx];
                if (!id) return;
                const newPlaced = [...placed];
                newPlaced[idx] = null;
                setPlaced(newPlaced);
                setAvailable([...available, id].sort());
                setResult(null);
            };

            const checkAnswer = () => {
                if (placed.includes(null)) { alert("Place all metals first!"); return; }
                const correctOrder = [...METAL_IDS].sort((a, b) => potentials[a] - potentials[b]);
                if (JSON.stringify(placed) === JSON.stringify(correctOrder)) setResult('CORRECT');
                else setResult('WRONG');
            };
            
            // Wire rendering logic
            const vVal = parseFloat(voltage);
            const redReverse = vVal < 0; 
            const blackReverse = vVal > 0;
            const hasVoltage = vVal !== 0;

            const getPathD = (coords) => {
                if (!coords) return "";
                // Hanging wire curve
                const controlY = Math.max(coords.start.y, coords.end.y) + 80;
                return `M ${coords.start.x} ${coords.start.y} Q ${(coords.start.x + coords.end.x)/2} ${controlY} ${coords.end.x} ${coords.end.y}`;
            };


            return (
                <div className="flex flex-col lg:flex-row h-full overflow-hidden">
                    {/* Findings Side Panel (Right on Desktop, Top on Mobile) */}
                    <div className="lg:w-64 w-full h-40 lg:h-full bg-slate-100 border-b lg:border-b-0 lg:border-l border-slate-200 p-2 flex-shrink-0 order-first lg:order-last overflow-hidden">
                        <FindingsPanel records={records} onClear={clearRecords} />
                    </div>

                    {/* Main Interaction Area */}
                    <div ref={containerRef} className="flex-1 overflow-y-auto p-4 flex flex-col items-center relative z-0">
                         {/* SVG Layer */}
                        <svg className="absolute top-0 left-0 w-full h-full pointer-events-none z-20 overflow-visible">
                             <defs>
                                <path id="con-red-wire" d={getPathD(wireCoords.red)} />
                                <path id="con-black-wire" d={getPathD(wireCoords.black)} />
                            </defs>
                            {wireCoords.red && (
                                <g>
                                    <path d={getPathD(wireCoords.red)} stroke="#ef4444" strokeWidth="4" fill="none" strokeLinecap="round" />
                                    {hasVoltage && isElectronVisible && [0, 0.5, 1, 1.5].map(d => (
                                        <ElectronParticle key={d} pathId="con-red-wire" delay={d} reverse={redReverse} />
                                    ))}
                                </g>
                            )}
                            {wireCoords.black && (
                                <g>
                                    <path d={getPathD(wireCoords.black)} stroke="#1f2937" strokeWidth="4" fill="none" strokeLinecap="round" />
                                    {hasVoltage && isElectronVisible && [0, 0.5, 1, 1.5].map(d => (
                                        <ElectronParticle key={d} pathId="con-black-wire" delay={d} reverse={blackReverse} />
                                    ))}
                                </g>
                            )}
                        </svg>

                        <div className="w-full max-w-2xl flex flex-col sm:flex-row justify-between items-center mb-6 z-10 gap-3">
                            <h2 className="text-xl font-bold text-slate-800">Consolidation Task</h2>
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setIsElectronVisible(!isElectronVisible)} 
                                    className={`px-3 py-1 rounded-full text-xs font-bold border flex items-center gap-1 transition-colors
                                        ${isElectronVisible ? 'bg-blue-100 text-blue-700 border-blue-300' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'}`}
                                >
                                    {isElectronVisible ? (
                                        <>
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.45 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                                            Hide e‚Åª Flow
                                        </>
                                    ) : (
                                        <>
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                            Show e‚Åª Flow
                                        </>
                                    )}
                                </button>
                                <button onClick={generateProblem} className="bg-purple-600 text-white px-3 py-1 rounded-full text-xs font-bold hover:bg-purple-500 shadow-md flex items-center gap-1">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                                    New Problem
                                </button>
                            </div>
                        </div>

                        {/* Multimeter */}
                        <div className="w-full max-w-[16rem] bg-slate-800 rounded-xl p-4 border-4 border-slate-700 shadow-xl mb-8 z-10">
                            <div className="lcd-screen rounded p-3 font-mono text-3xl text-green-400 text-right">
                                {voltage} V
                            </div>
                            <div className="flex justify-between items-center mt-4">
                                <div className="text-center">
                                    <div ref={redTermRef} className="w-4 h-4 bg-red-600 rounded-full mx-auto mb-1"></div>
                                    <span className="text-[10px] text-red-400 font-bold">RED (+)</span>
                                </div>
                                <button onClick={handleRecord} className="px-3 py-1 bg-slate-700 text-slate-300 text-xs rounded border border-slate-600 hover:bg-slate-600">
                                    Record
                                </button>
                                <div className="text-center">
                                    <div ref={blackTermRef} className="w-4 h-4 bg-slate-900 border border-slate-500 rounded-full mx-auto mb-1"></div>
                                    <span className="text-[10px] text-slate-400 font-bold">BLK (-)</span>
                                </div>
                            </div>
                        </div>

                        {/* Metal Rack */}
                        <div className="flex gap-3 justify-center mb-8 w-full max-w-md overflow-x-auto p-2 z-10">
                            {METAL_IDS.map(id => (
                                <div 
                                    key={id} 
                                    ref={el => metalRefs.current[id] = el}
                                    onClick={() => handleConnect(id)}
                                    className={`w-14 h-24 border-2 rounded-lg flex flex-col items-center justify-end pb-2 cursor-pointer transition-all relative
                                        ${redConn === id ? 'border-red-500 bg-red-50 ring-2 ring-red-200' : 
                                          blackConn === id ? 'border-slate-800 bg-slate-100 ring-2 ring-slate-300' : 'border-slate-300 bg-white hover:bg-slate-50'}
                                    `}
                                >
                                    <div className="w-8 h-16 bg-gradient-to-br from-slate-200 to-slate-400 rounded-sm mb-1"></div>
                                    <span className="font-bold text-sm text-slate-700">{id}</span>
                                    {redConn === id && <div className="absolute top-[-8px] w-4 h-4 bg-red-600 rounded-full shadow-sm"></div>}
                                    {blackConn === id && <div className="absolute top-[-8px] w-4 h-4 bg-slate-800 rounded-full shadow-sm"></div>}
                                </div>
                            ))}
                        </div>

                        <div className="w-full max-w-2xl border-t border-slate-200 mb-6 z-10"></div>

                        {/* Sorting Task */}
                        <div className="w-full max-w-2xl z-10">
                            <div className="flex justify-between items-end mb-2">
                                <h3 className="font-bold text-slate-700">Deduce Reactivity Series</h3>
                                <span className="text-xs text-slate-400">Ease of losing e‚Åª (Most to Least)</span>
                            </div>
                            
                            <div className="flex gap-2 w-full bg-slate-100 p-3 rounded-xl justify-center items-center shadow-inner mb-4 relative min-h-[5rem]">
                                 <svg className="absolute left-4 right-4 top-1/2 -translate-y-1/2 text-slate-300 pointer-events-none" height="20" width="100%">
                                    <line x1="0" y1="10" x2="100%" y2="10" stroke="currentColor" strokeWidth="2" strokeDasharray="4 4" />
                                    <polygon points="100%,10 98%,5 98%,15" fill="currentColor" transform="translate(-10, 0)" />
                                 </svg>
                                 {placed.map((id, idx) => (
                                     <div key={idx} onClick={() => handleRemove(idx)} className={`relative z-10 w-12 h-16 rounded border-2 flex items-center justify-center cursor-pointer bg-white ${id ? 'border-blue-300 shadow-sm' : 'border-dashed border-slate-300'}`}>
                                         {id ? <span className="font-bold text-slate-700">{id}</span> : <span className="text-slate-200 font-bold">{idx+1}</span>}
                                     </div>
                                 ))}
                            </div>

                            <div className="flex justify-center gap-3 min-h-[3rem]">
                                {available.map(id => (
                                    <button key={id} onClick={() => handlePlace(id)} className="w-10 h-10 rounded-full bg-white border border-slate-300 shadow-sm font-bold text-xs text-slate-600 hover:bg-slate-50">{id}</button>
                                ))}
                            </div>

                            <div className="flex justify-center mt-6">
                                <button onClick={checkAnswer} className="px-8 py-2 bg-indigo-600 text-white rounded-full font-bold shadow-lg hover:bg-indigo-700 transition-transform active:scale-95">Check Answer</button>
                            </div>

                            {result && (
                                <div className={`mt-4 p-3 rounded-lg text-center font-bold animate-bounce ${result === 'CORRECT' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                    {result === 'CORRECT' ? "üéâ Correct! You solved the mystery!" : "‚ùå Incorrect. Check your polarity readings."}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const FreePlayMode = () => {
            const [leftMetal, setLeftMetal] = useState(null);
            const [rightMetal, setRightMetal] = useState(null);
            const [isSwapped, setIsSwapped] = useState(false);
            const [voltage, setVoltage] = useState("0.00");
            
            const containerRef = useRef(null);
            const redTermRef = useRef(null);
            const blackTermRef = useRef(null);
            const leftBeakerRef = useRef(null);
            const rightBeakerRef = useRef(null);
            const [wireCoords, setWireCoords] = useState({ red: null, black: null });

            useEffect(() => {
                if (!leftMetal || !rightMetal) {
                    setVoltage("0.00");
                    return;
                }
                if (leftMetal.id === rightMetal.id) {
                    setVoltage("0.00");
                    return;
                }

                const redE = isSwapped ? rightMetal.E : leftMetal.E;
                const blackE = isSwapped ? leftMetal.E : rightMetal.E;
                
                const val = redE - blackE;
                setVoltage((val >= 0 ? "+" : "") + val.toFixed(2));

            }, [leftMetal, rightMetal, isSwapped]);

            useLayoutEffect(() => {
                const calculate = () => {
                    if (!containerRef.current) return;
                    const containerRect = containerRef.current.getBoundingClientRect();
                    const getCenter = (el) => {
                        if (!el) return { x: 0, y: 0 };
                        const rect = el.getBoundingClientRect();
                        return { x: rect.left + rect.width / 2 - containerRect.left, y: rect.top + rect.height / 2 - containerRect.top };
                    };
                    
                    const redStart = getCenter(redTermRef.current);
                    const blackStart = getCenter(blackTermRef.current);
                    const leftEnd = getCenter(leftBeakerRef.current);
                    const rightEnd = getCenter(rightBeakerRef.current);

                    leftEnd.y -= 40;
                    rightEnd.y -= 40;

                    if (isSwapped) {
                        setWireCoords({
                            red: { start: redStart, end: rightEnd },
                            black: { start: blackStart, end: leftEnd }
                        });
                    } else {
                        setWireCoords({
                            red: { start: redStart, end: leftEnd },
                            black: { start: blackStart, end: rightEnd }
                        });
                    }
                };
                calculate();
                window.addEventListener('resize', calculate);
                setTimeout(calculate, 50);
                return () => window.removeEventListener('resize', calculate);
            }, [isSwapped, leftMetal, rightMetal]);

            const vVal = parseFloat(voltage);
            const redReverse = vVal < 0; 
            const blackReverse = vVal > 0;
            const showElectrons = vVal !== 0;

            const getPathD = (coords) => {
                if (!coords) return "";
                return `M ${coords.start.x} ${coords.start.y} C ${coords.start.x} ${coords.start.y + 100}, ${coords.end.x} ${coords.end.y - 100}, ${coords.end.x} ${coords.end.y}`;
            };

            return (
                <div ref={containerRef} className="flex flex-col h-full p-4 sm:p-6 items-center overflow-y-auto bg-slate-50 relative">
                    <svg className="absolute top-0 left-0 w-full h-full pointer-events-none z-20 overflow-visible">
                        <defs>
                            <path id="red-wire-path" d={getPathD(wireCoords.red)} />
                            <path id="black-wire-path" d={getPathD(wireCoords.black)} />
                        </defs>
                        {wireCoords.red && (
                            <g>
                                <path d={getPathD(wireCoords.red)} stroke="#ef4444" strokeWidth="4" fill="none" />
                                {showElectrons && [0, 0.5, 1, 1.5].map(d => (
                                    <ElectronParticle key={d} pathId="red-wire-path" delay={d} reverse={redReverse} />
                                ))}
                            </g>
                        )}
                        {wireCoords.black && (
                            <g>
                                <path d={getPathD(wireCoords.black)} stroke="#1f2937" strokeWidth="4" fill="none" />
                                {showElectrons && [0, 0.5, 1, 1.5].map(d => (
                                    <ElectronParticle key={d} pathId="black-wire-path" delay={d} reverse={blackReverse} />
                                ))}
                            </g>
                        )}
                    </svg>

                    <div className="mb-6 text-center">
                        <h2 className="text-2xl font-bold text-slate-800">Free-Play Cell Builder</h2>
                        <p className="text-slate-600 text-sm">Design your own galvanic cell using common metals.</p>
                    </div>

                    <div className="w-full max-w-xs sm:w-64 bg-slate-800 rounded-xl p-4 border-4 border-slate-700 shadow-xl relative z-10 mb-8 sm:mb-12">
                        <div className="lcd-screen rounded p-2 font-mono text-3xl text-green-400 text-right">
                            {voltage} V
                        </div>
                        <div className="flex justify-between mt-4 px-4">
                            <div className="flex flex-col items-center">
                                <div ref={redTermRef} className="w-4 h-4 bg-red-600 rounded-full mb-1"></div>
                                <span className="text-[10px] text-red-400 font-bold">RED (+)</span>
                            </div>
                            <button 
                                onClick={() => setIsSwapped(!isSwapped)}
                                className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs rounded border border-slate-500 transition-colors"
                            >
                                ‚áÑ Swap
                            </button>
                            <div className="flex flex-col items-center">
                                <div ref={blackTermRef} className="w-4 h-4 bg-slate-900 border border-slate-500 rounded-full mb-1"></div>
                                <span className="text-[10px] text-slate-400 font-bold">BLK (-)</span>
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-center items-end gap-4 sm:gap-16 relative mb-8 sm:mb-12 w-full max-w-2xl z-10">
                        <div className="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-8 w-32 sm:w-40 h-20 border-t-8 border-x-8 border-slate-200 rounded-t-full opacity-60"></div>
                        <div className="flex flex-col items-center gap-2">
                            <span className="font-bold text-slate-500 text-xs sm:text-base">Left Electrode</span>
                            <div className="relative w-28 h-36 sm:w-32 sm:h-40 border-b-4 border-x-4 border-slate-300 rounded-b-lg bg-white overflow-hidden shadow-md">
                                <div className="absolute bottom-0 w-full h-3/4 bg-blue-50 opacity-50"></div>
                                {leftMetal ? (
                                    <div ref={leftBeakerRef} className={`absolute top-0 left-1/2 -translate-x-1/2 w-8 h-32 sm:h-36 ${leftMetal.color} border border-slate-400 shadow-sm flex items-end justify-center pb-2`}>
                                        <span className="font-bold text-slate-700">{leftMetal.id}</span>
                                    </div>
                                ) : (
                                    <div ref={leftBeakerRef} className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-slate-300 text-xs text-center p-2 border-2 border-dashed border-slate-200 rounded">
                                        Select Metal Below
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="flex flex-col items-center gap-2">
                            <span className="font-bold text-slate-500 text-xs sm:text-base">Right Electrode</span>
                            <div className="relative w-28 h-36 sm:w-32 sm:h-40 border-b-4 border-x-4 border-slate-300 rounded-b-lg bg-white overflow-hidden shadow-md">
                                <div className="absolute bottom-0 w-full h-3/4 bg-blue-50 opacity-50"></div>
                                {rightMetal ? (
                                    <div ref={rightBeakerRef} className={`absolute top-0 left-1/2 -translate-x-1/2 w-8 h-32 sm:h-36 ${rightMetal.color} border border-slate-400 shadow-sm flex items-end justify-center pb-2`}>
                                        <span className="font-bold text-slate-700">{rightMetal.id}</span>
                                    </div>
                                ) : (
                                    <div ref={rightBeakerRef} className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-slate-300 text-xs text-center p-2 border-2 border-dashed border-slate-200 rounded">
                                        Select Metal Below
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="w-full max-w-3xl bg-white p-4 sm:p-6 rounded-xl shadow-lg border border-slate-200 z-10">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-8">
                            <div>
                                <h3 className="text-xs sm:text-sm font-bold text-slate-400 uppercase mb-2 sm:mb-3">Set Left Electrode</h3>
                                <div className="grid grid-cols-3 gap-2">
                                    {FREE_PLAY_METALS.map(metal => (
                                        <button 
                                            key={metal.id}
                                            onClick={() => setLeftMetal(metal)}
                                            className={`p-2 rounded border-2 text-xs sm:text-sm font-bold transition-all ${leftMetal?.id === metal.id ? 'border-blue-500 bg-blue-50 text-blue-700 ring-2 ring-blue-200' : 'border-slate-200 hover:bg-slate-50 text-slate-600'}`}
                                        >
                                            {metal.id}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <h3 className="text-xs sm:text-sm font-bold text-slate-400 uppercase mb-2 sm:mb-3">Set Right Electrode</h3>
                                <div className="grid grid-cols-3 gap-2">
                                    {FREE_PLAY_METALS.map(metal => (
                                        <button 
                                            key={metal.id}
                                            onClick={() => setRightMetal(metal)}
                                            className={`p-2 rounded border-2 text-xs sm:text-sm font-bold transition-all ${rightMetal?.id === metal.id ? 'border-blue-500 bg-blue-50 text-blue-700 ring-2 ring-blue-200' : 'border-slate-200 hover:bg-slate-50 text-slate-600'}`}
                                        >
                                            {metal.id}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const LabBench = ({ addRecord, records, clearRecords }) => {
            const [redConn, setRedConn] = useState(null);
            const [blackConn, setBlackConn] = useState(null);
            const [tool, setTool] = useState(null);
            const [metalStates, setMetalStates] = useState({ W: { sanded: false }, X: { sanded: false }, Y: { sanded: false }, Z: { sanded: false } });
            const [isWet, setIsWet] = useState(false);
            const [voltage, setVoltage] = useState("0.00");
            const [message, setMessage] = useState("Select a tool to begin.");
            const [flow, setFlow] = useState(null);
            const [isRecorded, setIsRecorded] = useState(false);

            const containerRef = useRef(null);
            const redTerminalRef = useRef(null);
            const blackTerminalRef = useRef(null);
            const metalRefs = useRef({});
            const [wireCoords, setWireCoords] = useState({ red: null, black: null });

            useEffect(() => {
                setIsRecorded(false);
                if (!redConn || !blackConn) {
                    setVoltage("0.00"); setFlow(null); return;
                }
                if (redConn === blackConn) {
                    setVoltage("0.00"); setMessage("‚ö†Ô∏è Short Circuit! Probes on same metal."); setFlow(null); return;
                }
                if (!isWet) {
                    setVoltage("0.00"); setMessage("‚ö†Ô∏è Open Circuit! Filter paper is dry. Add electrolyte."); setFlow(null); return;
                }

                const isRedClean = metalStates[redConn].sanded;
                const isBlackClean = metalStates[blackConn].sanded;
                
                if (!isRedClean || !isBlackClean) {
                    const interval = setInterval(() => { const noise = (Math.random() * 0.1 - 0.05).toFixed(2); setVoltage(noise); }, 200);
                    setMessage("‚ö†Ô∏è Unstable Reading! Oxide layer detected. Use Sandpaper."); setFlow(null);
                    return () => clearInterval(interval);
                } else {
                    const val = (METALS_DATA[redConn].potential - METALS_DATA[blackConn].potential);
                    setVoltage((val >= 0 ? "+" : "") + val.toFixed(2));
                    if (val > 0) { setMessage(`‚úÖ Stable. Electrons flow from ${blackConn} (-) to ${redConn} (+).`); setFlow('BLACK_TO_RED'); }
                    else if (val < 0) { setMessage(`‚úÖ Stable. Electrons flow from ${redConn} (-) to ${blackConn} (+).`); setFlow('RED_TO_BLACK'); }
                    else { setMessage("Voltage is 0.00V"); setFlow(null); }
                }
            }, [redConn, blackConn, metalStates, isWet]);

            useLayoutEffect(() => {
                const calculate = () => {
                    if (!containerRef.current) return;
                    const containerRect = containerRef.current.getBoundingClientRect();
                    const getCenter = (el) => {
                        if (!el) return null;
                        const rect = el.getBoundingClientRect();
                        return { x: rect.left + rect.width / 2 - containerRect.left, y: rect.top + rect.height / 2 - containerRect.top };
                    };
                    let newCoords = { red: null, black: null };
                    if (redConn && redTerminalRef.current && metalRefs.current[redConn]) {
                        newCoords.red = { start: getCenter(redTerminalRef.current), end: getCenter(metalRefs.current[redConn]) };
                    }
                    if (blackConn && blackTerminalRef.current && metalRefs.current[blackConn]) {
                        newCoords.black = { start: getCenter(blackTerminalRef.current), end: getCenter(metalRefs.current[blackConn]) };
                    }
                    setWireCoords(newCoords);
                };
                calculate();
                window.addEventListener('resize', calculate);
                setTimeout(calculate, 50);
                return () => window.removeEventListener('resize', calculate);
            }, [redConn, blackConn]);

            const handleMetalClick = (id) => {
                if (!tool) { setMessage("Please select a tool first."); return; }
                if (tool === 'SANDPAPER') {
                    setMetalStates(prev => ({ ...prev, [id]: { sanded: true } }));
                    setMessage(`‚ú® Metal ${id} (${METALS_DATA[id].symbol}) polished!`);
                } else if (tool === 'RED_PROBE') setRedConn(id === redConn ? null : id);
                else if (tool === 'BLACK_PROBE') setBlackConn(id === blackConn ? null : id);
                else if (tool === 'DROPPER') setMessage("Use the dropper on the central filter paper, not the metals.");
            };

            const handlePaperClick = () => {
                if (tool === 'DROPPER') { setIsWet(true); setMessage("üíß Electrolyte added! Circuit path is now complete."); }
                else { setMessage("Use the Dropper tool to add saturated KNO‚ÇÉ."); }
            };

            const handleReset = () => {
                setRedConn(null); setBlackConn(null); setTool(null);
                setMetalStates({ W: { sanded: false }, X: { sanded: false }, Y: { sanded: false }, Z: { sanded: false } });
                setIsWet(false); setVoltage("0.00"); setMessage("Select a tool to begin."); setFlow(null);
            };

            const handleRecord = () => {
                if (voltage === "0.00" || message.includes("Unstable")) return;
                addRecord({
                    red: redConn,
                    black: blackConn,
                    voltage: voltage
                });
                setIsRecorded(true);
                setMessage("üíæ Data Recorded to Findings!");
            };

            const renderWire = (coords, colorClass) => {
                if (!coords) return null;
                const { start, end } = coords;
                const controlY = Math.max(start.y, end.y) + 50; 
                const path = `M ${start.x} ${start.y} Q ${(start.x + end.x)/2} ${controlY} ${end.x} ${end.y}`;
                return <path d={path} stroke="currentColor" strokeWidth="4" fill="none" strokeLinecap="round" className={`${colorClass} opacity-80`} />;
            };

            const canRecord = redConn && blackConn && isWet && metalStates[redConn].sanded && metalStates[blackConn].sanded && redConn !== blackConn;

            return (
                <div className="flex flex-col lg:flex-row h-full overflow-hidden">
                    <div className="lg:w-64 w-full h-40 lg:h-full bg-slate-100 border-b lg:border-b-0 lg:border-l border-slate-200 p-2 flex-shrink-0 order-first lg:order-last overflow-hidden">
                        <FindingsPanel records={records} onClear={clearRecords} />
                    </div>

                    <div ref={containerRef} className="flex-1 flex flex-col h-full p-2 sm:p-4 gap-4 sm:gap-6 items-center relative z-0 overflow-y-auto">
                        <svg className="absolute top-0 left-0 w-full h-full pointer-events-none z-20">
                            {renderWire(wireCoords.red, "text-red-500")}
                            {renderWire(wireCoords.black, "text-slate-800")}
                        </svg>

                        {/* MOBILE OPTIMIZED MULTIMETER */}
                        <div className="w-full max-w-[16rem] sm:max-w-md bg-slate-800 rounded-xl p-2 sm:p-6 border-4 border-slate-700 shadow-xl relative z-10">
                            <div className="text-[10px] sm:text-xs text-slate-400 mb-1 font-bold tracking-wider">DIGITAL MULTIMETER</div>
                            <div className="lcd-screen rounded p-2 sm:p-4 font-mono text-xl sm:text-4xl text-green-400 text-right flex justify-between items-center relative overflow-hidden">
                                <span className="text-[10px] sm:text-sm opacity-50 absolute top-2 left-2">DC V</span>
                                <span className="w-full">{voltage} <span className="text-lg sm:text-xl">V</span></span>
                            </div>
                            
                            <div className="mt-2 sm:mt-4 bg-slate-900 rounded p-2 text-[10px] sm:text-sm text-center text-yellow-400 font-mono flex items-center justify-center min-h-[2rem] sm:min-h-[3rem]">
                                {message}
                            </div>

                            <div className="flex justify-between items-center mt-2 sm:mt-6 px-2 sm:px-4">
                                <div className="flex flex-col items-center">
                                    <div ref={redTerminalRef} className="w-4 h-4 sm:w-6 sm:h-6 bg-red-900 border-2 border-red-500 rounded-full shadow-inner mb-1"></div>
                                    <span className="text-[10px] sm:text-xs text-red-400 font-bold">VŒ© (+)</span>
                                </div>

                                <button 
                                    onClick={handleRecord}
                                    disabled={!canRecord || isRecorded}
                                    className={`px-2 sm:px-4 py-1 sm:py-2 text-[10px] sm:text-xs font-bold rounded-full uppercase transition-all flex items-center gap-1 sm:gap-2 shadow-lg
                                        ${canRecord && !isRecorded ? 'bg-red-600 text-white hover:bg-red-500 animate-pulse ring-2 ring-red-400' : 
                                        isRecorded ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}`}
                                >
                                    {isRecorded ? (
                                        <>
                                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                                            Saved
                                        </>
                                    ) : (
                                        <>
                                            <div className={`w-1.5 h-1.5 sm:w-2 sm:h-2 rounded-full ${canRecord ? 'bg-white' : 'bg-slate-500'}`}></div>
                                            Record
                                        </>
                                    )}
                                </button>

                                <div className="flex flex-col items-center">
                                    <div ref={blackTerminalRef} className="w-4 h-4 sm:w-6 sm:h-6 bg-slate-900 border-2 border-slate-500 rounded-full shadow-inner mb-1"></div>
                                    <span className="text-[10px] sm:text-xs text-slate-400 font-bold">COM (-)</span>
                                </div>
                            </div>
                        </div>

                        <div className="relative w-64 h-64 xs:w-72 xs:h-72 sm:w-96 sm:h-96 bg-white rounded-full border-8 border-slate-200 shadow-inner flex items-center justify-center z-10">
                            <div onClick={handlePaperClick} className={`absolute inset-4 rounded-full border-2 border-dashed transition-all duration-500 cursor-pointer ${isWet ? 'bg-blue-100 border-blue-300 opacity-90 shadow-inner' : 'bg-slate-50 border-slate-300 opacity-50 hover:bg-slate-100'} ${(tool === 'DROPPER' && !isWet) ? 'ring-4 ring-blue-200 scale-105' : ''}`}>
                            </div>
                            {Object.values(METALS_DATA).map((metal, idx) => {
                                const positions = [
                                    { top: '5%', left: '50%', transform: 'translate(-50%, 0)' },
                                    { bottom: '5%', left: '50%', transform: 'translate(-50%, 0)' },
                                    { top: '50%', left: '5%', transform: 'translate(0, -50%) rotate(-90deg)' },
                                    { top: '50%', right: '5%', transform: 'translate(0, -50%) rotate(90deg)' }
                                ];
                                const isSanded = metalStates[metal.id].sanded;
                                const isRed = redConn === metal.id;
                                return (
                                    <div key={metal.id} ref={el => metalRefs.current[metal.id] = el} className={`absolute w-10 h-16 sm:w-20 sm:h-32 cursor-pointer transition-all duration-300 flex flex-col items-center justify-center border-2 ${isSanded ? 'metal-shiny border-slate-400' : 'metal-oxidized border-slate-600'} ${(tool === 'SANDPAPER' && !isSanded) ? 'hover:scale-105 hover:ring-2 ring-yellow-400' : ''} ${(tool?.includes('PROBE')) ? 'hover:scale-105 hover:ring-2 ring-blue-400' : ''}`} style={positions[idx]} onClick={(e) => { e.stopPropagation(); handleMetalClick(metal.id); }}>
                                        <span className="font-bold text-base sm:text-lg">{metal.id}</span>
                                    </div>
                                );
                            })}
                        </div>

                        <div className="text-center z-10 -mt-4 mb-2 bg-white/90 px-4 py-1 rounded-full border border-slate-200 shadow-sm">
                            <span className={`font-bold text-xs sm:text-sm ${isWet ? 'text-blue-600' : 'text-slate-500'}`}>
                                {isWet ? '‚úì Filter Paper Saturated' : '‚óã Dry Filter Paper'}
                            </span>
                        </div>

                        <div className="w-full max-w-lg bg-white p-2 sm:p-4 rounded-xl shadow-lg border border-slate-200 z-10">
                            <div className="flex justify-between items-center mb-1 sm:mb-2">
                                <div className="text-[10px] sm:text-xs font-bold text-slate-400 uppercase">Tools</div>
                                <button onClick={handleReset} className="text-[10px] sm:text-xs font-bold text-red-500 hover:text-red-700 uppercase flex items-center gap-1">
                                    <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                                    Reset Lab
                                </button>
                            </div>
                            <div className="grid grid-cols-4 gap-1 sm:gap-2">
                                <ToolButton label="Dropper (KNO‚ÇÉ)" color="bg-blue-100 text-blue-700 border-blue-300" active={tool === 'DROPPER'} onClick={() => setTool(tool === 'DROPPER' ? null : 'DROPPER')} icon={<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/></svg>} />
                                <ToolButton label="Red Probe" color="bg-red-100 text-red-700 border-red-300" active={tool === 'RED_PROBE'} onClick={() => setTool(tool === 'RED_PROBE' ? null : 'RED_PROBE')} icon={<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>} />
                                <ToolButton label="Black Probe" color="bg-slate-200 text-slate-800 border-slate-400" active={tool === 'BLACK_PROBE'} onClick={() => setTool(tool === 'BLACK_PROBE' ? null : 'BLACK_PROBE')} icon={<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>} />
                                <ToolButton label="Sandpaper" color="bg-yellow-100 text-yellow-700 border-yellow-300" active={tool === 'SANDPAPER'} onClick={() => setTool(tool === 'SANDPAPER' ? null : 'SANDPAPER')} icon={<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ToolButton = ({ label, color, active, onClick, icon }) => (
            <button onClick={onClick} className={`flex-1 py-2 sm:py-3 px-1 rounded-lg border-2 font-bold text-[10px] sm:text-xs transition-all flex flex-col items-center gap-1 justify-center ${active ? color + ' ring-2 ring-offset-2 ring-blue-400 scale-105 shadow-md' : 'bg-slate-50 border-transparent text-slate-500 hover:bg-slate-100'}`}>{icon}<span className="text-center leading-tight">{label}</span></button>
        );

        const QuizMode = ({ records }) => {
            const [placed, setPlaced] = useState([null, null, null, null]);
            const [available, setAvailable] = useState(['W', 'X', 'Y', 'Z']);
            const [selectedPair, setSelectedPair] = useState([]);
            const [result, setResult] = useState(null); // { sort: bool, pair: bool }

            const handlePlace = (metalId) => {
                const firstEmptyIndex = placed.indexOf(null);
                if (firstEmptyIndex === -1) return;
                const newPlaced = [...placed];
                newPlaced[firstEmptyIndex] = metalId;
                setPlaced(newPlaced);
                setAvailable(available.filter(id => id !== metalId));
                setResult(null);
            };

            const handleRemove = (index) => {
                const metalId = placed[index];
                if (!metalId) return;
                const newPlaced = [...placed];
                newPlaced[index] = null;
                setPlaced(newPlaced);
                setAvailable([...available, metalId].sort());
                setResult(null);
            };

            const togglePairSelection = (id) => {
                if (selectedPair.includes(id)) {
                    setSelectedPair(selectedPair.filter(m => m !== id));
                } else {
                    if (selectedPair.length < 2) {
                        setSelectedPair([...selectedPair, id]);
                    }
                }
                setResult(null);
            };

            const checkAnswer = () => {
                const isFull = placed.every(p => p !== null);
                if (!isFull) { alert("Please complete the Reactivity sorting first!"); return; }
                if (selectedPair.length !== 2) { alert("Please select exactly two metals for the max voltage pair!"); return; }
                
                const sortingCorrect = JSON.stringify(placed) === JSON.stringify(CORRECT_ORDER);
                const pairCorrect = selectedPair.includes('X') && selectedPair.includes('Y');

                setResult({ sort: sortingCorrect, pair: pairCorrect });
            };

            const resetQuiz = () => {
                setPlaced([null, null, null, null]);
                setAvailable(['W', 'X', 'Y', 'Z']);
                setSelectedPair([]);
                setResult(null);
            };

            return (
                <div className="flex flex-col lg:flex-row h-full overflow-hidden">
                    
                    {/* Findings Side Panel (Right on Desktop, Top on Mobile) */}
                    <div className="lg:w-64 w-full h-40 lg:h-full bg-slate-100 border-b lg:border-b-0 lg:border-l border-slate-200 p-2 flex-shrink-0 order-first lg:order-last overflow-hidden">
                        <FindingsPanel records={records} />
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 flex flex-col items-center">
                        <div className="bg-indigo-50 p-6 rounded-xl border border-indigo-200 max-w-2xl w-full mb-8 shadow-sm">
                            <h2 className="font-bold text-indigo-900 text-xl mb-2 flex items-center gap-2">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>
                                Reactivity & Voltage Quiz
                            </h2>
                            <p className="text-indigo-800 text-sm">
                                Complete both tasks below to verify your experimental findings.
                            </p>
                        </div>

                        {/* TASK 1: SORTING */}
                        <div className="w-full max-w-2xl mb-8">
                            <h3 className="text-md font-bold text-slate-700 mb-2 uppercase tracking-wide">1. Reactivity Series</h3>
                            <p className="text-sm text-slate-500 mb-4">Arrange the metals from Most Reactive to Least Reactive.</p>
                            
                            <div className="flex flex-col items-center gap-2">
                                <div className="w-full flex justify-between px-4 text-xs font-bold text-slate-400 uppercase">
                                    <span>Most Reactive</span>
                                    <span>Least Reactive</span>
                                </div>
                                <div className="flex gap-2 sm:gap-4 w-full bg-slate-200 p-4 rounded-xl justify-center items-center shadow-inner relative">
                                    <div className="absolute top-1/2 left-4 right-4 h-1 bg-slate-300 -z-0"></div>
                                    <svg className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-300" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                                    {placed.map((metalId, idx) => (
                                        <div key={idx} onClick={() => handleRemove(idx)} className={`relative z-10 w-16 h-20 sm:w-24 sm:h-28 rounded-lg flex flex-col items-center justify-center cursor-pointer transition-all ${metalId ? 'bg-white shadow-md border-2 border-blue-200 hover:border-red-300' : 'quiz-slot hover:bg-slate-100'}`}>
                                            {metalId ? <span className="font-bold text-xl">{metalId}</span> : <span className="text-slate-300 font-bold text-2xl opacity-50">{idx + 1}</span>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Pool */}
                            <div className="flex justify-center gap-4 mt-4 min-h-[4rem]">
                                {available.map((id) => (
                                    <button key={id} onClick={() => handlePlace(id)} className="w-12 h-12 rounded-full bg-slate-100 border-2 border-slate-300 hover:bg-blue-50 hover:border-blue-400 hover:scale-110 transition-all font-bold text-lg shadow-sm text-slate-700">{id}</button>
                                ))}
                            </div>
                            
                            {result && (
                                <div className={`mt-2 text-sm font-bold text-center ${result.sort ? 'text-green-600' : 'text-red-500'}`}>
                                    {result.sort ? "‚úÖ Reactivity Order Correct" : "‚ùå Incorrect Order"}
                                </div>
                            )}
                        </div>

                        <div className="w-full max-w-2xl border-t border-slate-200 my-4"></div>

                        {/* TASK 2: MAX VOLTAGE */}
                        <div className="w-full max-w-2xl mb-8">
                            <h3 className="text-md font-bold text-slate-700 mb-2 uppercase tracking-wide">2. Max Voltage Challenge</h3>
                            <p className="text-sm text-slate-500 mb-4">Select the two metals that would produce the <strong>highest voltage</strong> when coupled.</p>
                            
                            <div className="flex justify-center gap-4">
                                {['W', 'X', 'Y', 'Z'].map(id => {
                                    const isSelected = selectedPair.includes(id);
                                    return (
                                        <button 
                                            key={id} 
                                            onClick={() => togglePairSelection(id)}
                                            className={`w-16 h-16 rounded-xl border-2 font-bold text-xl transition-all flex flex-col items-center justify-center
                                                ${isSelected ? 'bg-blue-600 text-white border-blue-600 shadow-lg scale-110' : 'bg-white text-slate-600 border-slate-300 hover:border-blue-300'}
                                            `}
                                        >
                                            {id}
                                        </button>
                                    );
                                })}
                            </div>
                            
                            {result && (
                                <div className={`mt-4 text-sm font-bold text-center ${result.pair ? 'text-green-600' : 'text-red-500'}`}>
                                    {result.pair 
                                        ? "‚úÖ Correct! Mg and Cu have the largest potential difference (~1.63V)." 
                                        : "‚ùå Incorrect Pair. Look for metals furthest apart in the series."}
                                </div>
                            )}
                        </div>

                        {/* CONTROLS */}
                        <div className="flex gap-4 justify-center w-full max-w-2xl pt-4 border-t border-slate-200">
                            <button onClick={resetQuiz} className="px-6 py-2 rounded-lg text-slate-500 font-bold hover:bg-slate-100 transition">Reset All</button>
                            <button onClick={checkAnswer} className="px-8 py-2 rounded-lg bg-indigo-600 text-white font-bold shadow-lg hover:bg-indigo-700 hover:scale-105 transition flex items-center gap-2">Check Answers</button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>