<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Lewis Structure Builder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* Basic Resets and Root Font Size for REM units */
        :root {
            font-size: 16px; /* 1rem = 16px */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-size: 1rem;
            overflow-x: hidden;
        }
        
        /* Initial Mode Selection Modal */
        #mode-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 2rem 3rem;
            border-radius: 0.75rem;
            text-align: center;
            box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.2);
            max-width: 90%;
            width: 35rem;
        }

        .modal-content h1 {
            margin-bottom: 1rem;
            color: #4a69bd;
        }
        
        .modal-content p {
            margin-bottom: 1.5rem;
            color: #555;
            line-height: 1.5;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .modal-btn {
            padding: 0.75rem 2rem;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
        }

        #modal-practice-btn {
            background-color: #3f51b5;
            color: white;
        }

        #modal-quiz-btn {
            background-color: #2e7d32;
            color: white;
        }
        
        /* Main application container, hidden initially */
        #app-container {
            display: none;
            flex-direction: column;
            flex-grow: 1;
        }

        /* Header Styling */
        header {
            background-color: #4a69bd;
            color: white;
            text-align: center;
            padding: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.1);
            z-index: 10;
        }

        /* Mode Selector Styling */
        .mode-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: #e8eaf6;
            gap: 2rem;
        }

        .mode-btn {
            padding: 0.5rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            border: 0.125rem solid #9fa8da;
            border-radius: 0.5rem;
            background-color: #fff;
            color: #3f51b5;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, opacity 0.2s;
        }
        
        .mode-btn:disabled {
            background-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
            border-color: #dee2e6;
            opacity: 0.7;
        }
        
        .mode-btn.active {
            background-color: #3f51b5;
            color: white;
        }
        
        #quiz-info {
            font-weight: bold;
            font-size: 1.1rem;
            color: #3f51b5;
        }

        /* Main Flex Container */
        .main-container {
            display: flex;
            flex-grow: 1;
            width: 98%;
            max-width: 93.75rem; /* 1500px */
            margin: 1rem auto;
            gap: 1rem;
        }

        /* Toolbox Styling (Left Column) */
        .tool-panel {
            flex: 1;
            min-width: 13.75rem; /* 220px */
            max-width: 15.625rem; /* 250px */
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .tool-panel h2 {
            margin-bottom: 0.5rem;
            color: #4a69bd;
            border-bottom: 0.125rem solid #e1e1e1; /* 2px */
            padding-bottom: 0.5rem;
            text-align: center;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .atom-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(2.75rem, 1fr));
            gap: 0.5rem;
        }
        
        .tool-btn {
            padding: 0.75rem 0;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            border: 0.125rem solid #ddd; /* 2px */
            border-radius: 0.5rem; /* 8px */
            background-color: #f8f9fa;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s, color 0.2s, border-color 0.2s;
            user-select: none;
        }

        .tool-btn.active {
            background-color: #4a69bd;
            color: white;
            border-color: #4a69bd;
        }
        
        .tool-btn:disabled {
            background-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
            border-color: #dee2e6;
        }
        
        #reset-btn {
            background-color: #fbe9e7;
            border-color: #ffab91;
            color: #d84315;
        }

        #reset-btn:hover {
            background-color: #ffccbc;
            border-color: #ff8a65;
        }
        
        #check-btn {
            background-color: #e8f5e9;
            border-color: #a5d6a7;
            color: #2e7d32;
        }
        #check-btn:hover {
            background-color: #c8e6c9;
            border-color: #81c784;
        }

        .atom-btn {
            padding: 0.75rem 0;
            font-size: 1.25rem;
            font-weight: bold;
            text-align: center;
            border: 0.125rem solid #ddd; /* 2px */
            border-radius: 0.5rem; /* 8px */
            background-color: #f8f9fa;
            cursor: grab;
            transition: background-color 0.2s, box-shadow 0.2s;
            user-select: none;
        }

        .atom-btn:hover {
            background-color: #e9ecef;
            border-color: #4a69bd;
        }

        .atom-btn:active {
            cursor: grabbing;
            background-color: #d1d8e0;
            box-shadow: inset 0 0.125rem 0.25rem rgba(0,0,0,0.1);
        }

        /* Canvas Area Styling */
        .canvas-area {
            flex: 4;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Feedback Area Styling */
        #feedback-area {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 1rem;
            font-size: 1.1rem;
            transition: background-color 0.3s, color 0.3s;
            border-radius: 0.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.1);
        }
        
        #feedback-area.success {
            background-color: #2e7d32;
        }
        
        #feedback-area.error {
            background-color: #d32f2f;
        }
        
        #feedback-area.quiz-mode-instructions {
            background-color: #e3f2fd; /* Eye-catching light blue */
            color: #0d47a1; /* Darker blue text for contrast */
        }

        #instructions h4 {
            margin-bottom: 0.5rem;
        }
        
        #instructions ul {
            list-style-position: inside;
            text-align: left;
            display: inline-block;
            margin-top: 0.25rem;
        }
        
        #quiz-question-area {
            font-weight: bold;
            font-size: 1.25rem; /* Increased font size */
        }
        
        #quiz-question-area span {
            font-family: monospace;
            font-size: 1.5rem; /* Increased font size */
            background-color: rgba(0,0,0,0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
        }

        /* Canvas Styling */
        .canvas-panel {
            flex-grow: 1;
            background-color: #ffffff;
            border: 0.125rem dashed #cccccc; /* 2px */
            border-radius: 0.5rem; /* 8px */
            width: 100%;
            max-width: 100%;
            touch-action: none; /* Prevents default touch actions like scrolling */
        }
        
        .canvas-panel.tool-active {
            cursor: crosshair;
        }
        
        /* Confetti Styling */
        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 2000;
        }
        .confetti {
            position: absolute;
            width: 0.5rem;
            height: 1rem;
            background-color: #f00;
            opacity: 0;
            animation: fall 5s ease-in-out forwards;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; }
            100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; }
        }

        /* Tutorial Panel Styling */
        #tutorial-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background-color: #fffde7;
            border: 2px solid #fff9c4;
            border-radius: 0.75rem;
            padding: 2rem;
            width: 90%;
            max-width: 32rem;
            box-shadow: 0 0.5rem 2rem rgba(0,0,0,0.25);
            z-index: 500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        }

        #tutorial-panel.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }

        #tutorial-panel h3 {
            font-size: 1.75rem;
            color: #4a69bd;
            margin-bottom: 1.5rem;
        }

        #tutorial-panel ul {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        #tutorial-panel li {
            font-size: 1.15rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        #tutorial-panel li strong {
            color: #3f51b5;
            display: inline-block;
            width: 8rem;
        }

        #close-tutorial-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 2.5rem;
            color: #bdbdbd;
            cursor: pointer;
            line-height: 1;
        }
        #close-tutorial-btn:hover {
            color: #757575;
        }


        /* Responsive Design: Single-column layout for smaller screens */
        @media (max-width: 48rem) { /* 768px */
            .main-container {
                flex-direction: column;
            }
            .tool-panel {
                max-width: 100%;
            }
            .canvas-panel {
                min-height: 60vh;
            }
        }
    </style>
</head>
<body>

    <div id="mode-selection-modal">
        <div class="modal-content">
            <h1 id="modal-title">Welcome to the Lewis Structure Builder!</h1>
            <p id="modal-text">This tool helps you practice drawing Lewis structures. Use the toolbox to drag atoms, create bonds, and add electrons. Choose a mode to begin.</p>
            <div class="modal-buttons">
                <button id="modal-practice-btn" class="modal-btn">Practice Mode</button>
                <button id="modal-quiz-btn" class="modal-btn">Quiz Mode</button>
            </div>
        </div>
    </div>

    <div id="app-container">
        <header>
            <h1>Interactive Lewis Structure Builder</h1>
        </header>

        <div class="mode-selector">
            <button id="practice-mode-btn" class="mode-btn active">Practice Mode</button>
            <button id="quiz-mode-btn" class="mode-btn">Quiz Mode</button>
            <div id="quiz-info" style="display: none;">
                <span id="question-counter"></span> | <span id="score-counter"></span>
            </div>
        </div>

        <main class="main-container">
            <div id="toolbox" class="tool-panel">
                <h2>Toolbox</h2>
                <div class="atom-buttons">
                    <div class="atom-btn" draggable="true" data-atom="H">H</div>
                    <div class="atom-btn" draggable="true" data-atom="Be">Be</div>
                    <div class="atom-btn" draggable="true" data-atom="B">B</div>
                    <div class="atom-btn" draggable="true" data-atom="C">C</div>
                    <div class="atom-btn" draggable="true" data-atom="N">N</div>
                    <div class="atom-btn" draggable="true" data-atom="O">O</div>
                    <div class="atom-btn" draggable="true" data-atom="F">F</div>
                    <div class="atom-btn" draggable="true" data-atom="Si">Si</div>
                    <div class="atom-btn" draggable="true" data-atom="P">P</div>
                    <div class="atom-btn" draggable="true" data-atom="S">S</div>
                    <div class="atom-btn" draggable="true" data-atom="Cl">Cl</div>
                    <div class="atom-btn" draggable="true" data-atom="Br">Br</div>
                    <div class="atom-btn" draggable="true" data-atom="I">I</div>
                </div>
                <div class="action-buttons">
                    <button id="bond-tool" class="tool-btn">Bond</button>
                    <button id="electron-tool" class="tool-btn">Electrons</button>
                    <button id="undo-btn" class="tool-btn">Undo</button>
                    <button id="redo-btn" class="tool-btn">Redo</button>
                    <button id="reset-btn" class="tool-btn">Reset Canvas</button>
                    <button id="check-btn" class="tool-btn">Check Answer</button>
                    <button id="show-answer-btn" class="tool-btn" style="display: none;">Show Answer</button>
                    <button id="next-molecule-btn" class="tool-btn" style="display: none;">Next Question</button>
                </div>
            </div>
            <div class="canvas-area">
                <div id="feedback-area">
                    <p id="instructions">Instructions: Drag an atom from the toolbox and drop it onto the canvas.</p>
                </div>
                <canvas id="drawing-board" class="canvas-panel"></canvas>
            </div>
        </main>
    </div>
    <div id="confetti-container"></div>
    <div id="tutorial-panel">
        <button id="close-tutorial-btn">&times;</button>
        <h3>How to Build a Molecule</h3>
        <ul>
            <li><strong>Add Atoms:</strong> Drag atoms from the toolbox onto the canvas.</li>
            <li><strong>Single Bonds:</strong> Activate the 'Bond' tool, then click and drag between two atoms.</li>
            <li><strong>Multiple Bonds:</strong> With the 'Bond' tool active, click an existing bond to add more bonds.</li>
            <li><strong>Lone Pairs:</strong> Activate the 'Electrons' tool and click on an atom to add lone pairs.</li>
        </ul>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('drawing-board');
            const ctx = canvas.getContext('2d');
            const atomButtons = document.querySelectorAll('.atom-btn');
            const bondToolBtn = document.getElementById('bond-tool');
            const electronToolBtn = document.getElementById('electron-tool');
            const resetBtn = document.getElementById('reset-btn');
            const checkBtn = document.getElementById('check-btn');
            const showAnswerBtn = document.getElementById('show-answer-btn');
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            const instructions = document.getElementById('instructions');
            const feedbackArea = document.getElementById('feedback-area');
            const practiceModeBtn = document.getElementById('practice-mode-btn');
            const quizModeBtn = document.getElementById('quiz-mode-btn');
            const nextMoleculeBtn = document.getElementById('next-molecule-btn');
            const modeSelectionModal = document.getElementById('mode-selection-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalText = document.getElementById('modal-text');
            const modalPracticeBtn = document.getElementById('modal-practice-btn');
            const modalQuizBtn = document.getElementById('modal-quiz-btn');
            const appContainer = document.getElementById('app-container');
            const quizInfo = document.getElementById('quiz-info');
            const questionCounter = document.getElementById('question-counter');
            const scoreCounter = document.getElementById('score-counter');
            const confettiContainer = document.getElementById('confetti-container');
            const tutorialPanel = document.getElementById('tutorial-panel');
            const closeTutorialBtn = document.getElementById('close-tutorial-btn');

            // --- State ---
            let placedAtoms = [];
            let placedBonds = [];
            let currentTool = 'none';
            let isBonding = false;
            let bondStartAtom = null;
            let historyStack = [];
            let historyIndex = -1;
            let currentMode = 'practice';
            let quizSessionMolecules = [];
            let currentQuestionIndex = 0;
            let score = 0;
            let questionAnswered = false;
            
            const quizMolecules = [
                'H2O', 'CO2', 'NH3', 'CH4', 'BF3', 'PCl5', 'SF6', 'O2', 'N2', 
                'SiF4', 'CS2', 'H2S', 'SCl2', 'PH3', 'OF2', 'SiH4', 'PBr3'
            ];
            
            // --- Answer Key for Quiz Mode ---
            const answerKey = {
                'H2O': { atoms: [{s:'O',lp:2},{s:'H',lp:0},{s:'H',lp:0}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1}] },
                'CO2': { atoms: [{s:'C',lp:0},{s:'O',lp:2},{s:'O',lp:2}], bonds: [{s:0,e:1,t:2},{s:0,e:2,t:2}] },
                'NH3': { atoms: [{s:'N',lp:1},{s:'H',lp:0},{s:'H',lp:0},{s:'H',lp:0}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1},{s:0,e:3,t:1}] },
                'CH4': { atoms: [{s:'C',lp:0},{s:'H',lp:0},{s:'H',lp:0},{s:'H',lp:0},{s:'H',lp:0}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1},{s:0,e:3,t:1},{s:0,e:4,t:1}] },
                'BF3': { atoms: [{s:'B',lp:0},{s:'F',lp:3},{s:'F',lp:3},{s:'F',lp:3}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1},{s:0,e:3,t:1}] },
                'PCl5': { atoms: [{s:'P',lp:0},{s:'Cl',lp:3},{s:'Cl',lp:3},{s:'Cl',lp:3},{s:'Cl',lp:3},{s:'Cl',lp:3}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1},{s:0,e:3,t:1},{s:0,e:4,t:1},{s:0,e:5,t:1}] },
                'SF6': { atoms: [{s:'S',lp:0},{s:'F',lp:3},{s:'F',lp:3},{s:'F',lp:3},{s:'F',lp:3},{s:'F',lp:3},{s:'F',lp:3}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1},{s:0,e:3,t:1},{s:0,e:4,t:1},{s:0,e:5,t:1},{s:0,e:6,t:1}] },
                'O2': { atoms: [{s:'O',lp:2},{s:'O',lp:2}], bonds: [{s:0,e:1,t:2}] },
                'N2': { atoms: [{s:'N',lp:1},{s:'N',lp:1}], bonds: [{s:0,e:1,t:3}] },
                'SiF4': { atoms: [{s:'Si',lp:0},{s:'F',lp:3},{s:'F',lp:3},{s:'F',lp:3},{s:'F',lp:3}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1},{s:0,e:3,t:1},{s:0,e:4,t:1}] },
                'CS2': { atoms: [{s:'C',lp:0},{s:'S',lp:2},{s:'S',lp:2}], bonds: [{s:0,e:1,t:2},{s:0,e:2,t:2}] },
                'H2S': { atoms: [{s:'S',lp:2},{s:'H',lp:0},{s:'H',lp:0}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1}] },
                'SCl2': { atoms: [{s:'S',lp:2},{s:'Cl',lp:3},{s:'Cl',lp:3}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1}] },
                'PH3': { atoms: [{s:'P',lp:1},{s:'H',lp:0},{s:'H',lp:0},{s:'H',lp:0}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1},{s:0,e:3,t:1}] },
                'OF2': { atoms: [{s:'O',lp:2},{s:'F',lp:3},{s:'F',lp:3}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1}] },
                'SiH4': { atoms: [{s:'Si',lp:0},{s:'H',lp:0},{s:'H',lp:0},{s:'H',lp:0},{s:'H',lp:0}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1},{s:0,e:3,t:1},{s:0,e:4,t:1}] },
                'PBr3': { atoms: [{s:'P',lp:1},{s:'Br',lp:3},{s:'Br',lp:3},{s:'Br',lp:3}], bonds: [{s:0,e:1,t:1},{s:0,e:2,t:1},{s:0,e:3,t:1}] },
            };

            const valenceElectrons = { 
                'H': 1, 'C': 4, 'N': 5, 'O': 6, 'F': 7, 'Cl': 7, 
                'Be': 2, 'B': 3, 'Si': 4, 'P': 5, 'S': 6, 'Br': 7, 'I': 7 
            };
            
            const octetRules = {
                'H': { type: 'exact', value: 2, name: 'duet rule' },
                'Be': { type: 'exact', value: 4, name: 'rule' },
                'B': { type: 'exact', value: 6, name: 'rule' },
                'P': { type: 'expanded', values: [8, 10, 12], name: 'expanded octet' },
                'S': { type: 'expanded', values: [8, 10, 12], name: 'expanded octet' },
                'Si': { type: 'expanded', values: [8, 10, 12], name: 'expanded octet' },
                'Cl': { type: 'expanded', values: [8, 10, 12], name: 'expanded octet' },
                'Br': { type: 'expanded', values: [8, 10, 12], name: 'expanded octet' },
                'I': { type: 'expanded', values: [8, 10, 12], name: 'expanded octet' },
            };
            
            // --- Sound Effects ---
            const correctSound = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 }
            }).toDestination();
            const wrongSound = new Tone.Synth({
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.5 }
            }).toDestination();

            // --- Canvas Sizing ---
            function resizeCanvas() {
                canvas.width = canvas.clientWidth;
                canvas.height = canvas.clientHeight;
                drawCanvas();
            }
            window.addEventListener('resize', resizeCanvas);
            
            // --- History Management ---
            function saveState() {
                clearFeedback();
                if (historyIndex < historyStack.length - 1) {
                    historyStack = historyStack.slice(0, historyIndex + 1);
                }
                const state = {
                    atoms: JSON.parse(JSON.stringify(placedAtoms)),
                    bonds: JSON.parse(JSON.stringify(placedBonds))
                };
                if (historyStack.length > 0 && JSON.stringify(state) === JSON.stringify(historyStack[historyStack.length - 1])) {
                    return;
                }
                historyStack.push(state);
                historyIndex = historyStack.length - 1;
                updateHistoryButtons();
            }

            function loadState(state) {
                clearFeedback();
                placedAtoms = JSON.parse(JSON.stringify(state.atoms));
                placedBonds = JSON.parse(JSON.stringify(state.bonds)).map(bond => {
                    const newStart = placedAtoms.find(a => a.x === bond.start.x && a.y === bond.start.y && a.symbol === bond.start.symbol);
                    const newEnd = placedAtoms.find(a => a.x === bond.end.x && a.y === bond.end.y && a.symbol === bond.end.symbol);
                    return { ...bond, start: newStart, end: newEnd };
                });
                drawCanvas();
            }

            function undo() {
                if (historyIndex > 0) {
                    historyIndex--;
                    loadState(historyStack[historyIndex]);
                    updateHistoryButtons();
                }
            }

            function redo() {
                if (historyIndex < historyStack.length - 1) {
                    historyIndex++;
                    loadState(historyStack[historyIndex]);
                    updateHistoryButtons();
                }
            }

            function updateHistoryButtons() {
                undoBtn.disabled = historyIndex <= 0;
                redoBtn.disabled = historyIndex >= historyStack.length - 1;
            }

            // --- Drawing Functions ---
            function drawCanvas() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                placedBonds.forEach(drawBond);
                placedAtoms.forEach(drawAtom);
            }

            function drawAtom(atom) {
                ctx.beginPath();
                ctx.arc(atom.x, atom.y, 25, 0, Math.PI * 2);
                ctx.fillStyle = '#e9ecef';
                ctx.fill();
                ctx.strokeStyle = '#495057';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.closePath();
                ctx.fillStyle = '#212529';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(atom.symbol, atom.x, atom.y);
                drawLonePairs(atom);
            }
            
            function drawLonePairs(atom) {
                if (!atom.lonePairs || atom.lonePairs.length === 0) return;

                const positions = { top: true, right: true, bottom: true, left: true };

                placedBonds.forEach(bond => {
                    if (bond.start === atom || bond.end === atom) {
                        const otherAtom = bond.start === atom ? bond.end : bond.start;
                        if (!otherAtom) return;
                        const dx = otherAtom.x - atom.x;
                        const dy = otherAtom.y - atom.y;
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;

                        if (angle > -45 && angle <= 45) positions.right = false;
                        else if (angle > 45 && angle <= 135) positions.bottom = false;
                        else if (angle > 135 || angle <= -135) positions.left = false;
                        else if (angle > -135 && angle <= -45) positions.top = false;
                    }
                });

                const availablePositions = Object.keys(positions).filter(p => positions[p]);
                
                const electronRadius = 3;
                const pairOffset = 5;
                const atomRadiusOffset = 35;

                atom.lonePairs.forEach((pair, index) => {
                    if (index < availablePositions.length) {
                        const pos = availablePositions[index];
                        let angle = 0;
                        if (pos === 'top') angle = -Math.PI / 2;
                        if (pos === 'right') angle = 0;
                        if (pos === 'bottom') angle = Math.PI / 2;
                        if (pos === 'left') angle = Math.PI;

                        const midX = atom.x + Math.cos(angle) * atomRadiusOffset;
                        const midY = atom.y + Math.sin(angle) * atomRadiusOffset;
                        const perpAngle = angle + Math.PI / 2;
                        const e1x = midX + Math.cos(perpAngle) * pairOffset;
                        const e1y = midY + Math.sin(perpAngle) * pairOffset;
                        const e2x = midX - Math.cos(perpAngle) * pairOffset;
                        const e2y = midY - Math.sin(perpAngle) * pairOffset;
                        ctx.fillStyle = '#343a40';
                        ctx.beginPath(); ctx.arc(e1x, e1y, electronRadius, 0, Math.PI * 2); ctx.fill();
                        ctx.beginPath(); ctx.arc(e2x, e2y, electronRadius, 0, Math.PI * 2); ctx.fill();
                    }
                });
            }

            function drawBond(bond) {
                if (!bond.start || !bond.end) return;
                const start = bond.start;
                const end = bond.end;
                const dx = end.x - start.x;
                const dy = end.y - start.y;
                const angle = Math.atan2(dy, dx);
                const perpX = -Math.sin(angle);
                const perpY = Math.cos(angle);
                const offset = 4;
                ctx.strokeStyle = '#343a40';
                ctx.lineWidth = 3;
                if (bond.type === 1) {
                    ctx.beginPath(); ctx.moveTo(start.x, start.y); ctx.lineTo(end.x, end.y); ctx.stroke();
                } else if (bond.type === 2) {
                    ctx.beginPath(); ctx.moveTo(start.x + perpX * offset, start.y + perpY * offset); ctx.lineTo(end.x + perpX * offset, end.y + perpY * offset); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(start.x - perpX * offset, start.y - perpY * offset); ctx.lineTo(end.x - perpX * offset, end.y - perpY * offset); ctx.stroke();
                } else if (bond.type === 3) {
                    ctx.beginPath(); ctx.moveTo(start.x, start.y); ctx.lineTo(end.x, end.y); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(start.x + perpX * offset * 2, start.y + perpY * offset * 2); ctx.lineTo(end.x + perpX * offset * 2, end.y + perpY * offset * 2); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(start.x - perpX * offset * 2, start.y - perpY * offset * 2); ctx.lineTo(end.x - perpX * offset * 2, end.y - perpY * offset * 2); ctx.stroke();
                }
            }
            
            // --- Tool & Mode Management ---
            function setTool(tool) {
                currentTool = (currentTool === tool) ? 'none' : tool;
                updateUIToReflectTool();
            }
            
            function setMode(mode) {
                currentMode = mode;
                practiceModeBtn.classList.toggle('active', mode === 'practice');
                quizModeBtn.classList.toggle('active', mode === 'quiz');
                quizInfo.style.display = (mode === 'quiz') ? 'block' : 'none';
                nextMoleculeBtn.style.display = (mode === 'quiz') ? 'block' : 'none';
                showAnswerBtn.style.display = (mode === 'quiz') ? 'block' : 'none';
                resetCanvas();
                if(mode === 'quiz') {
                    startNewQuiz();
                } else {
                    practiceModeBtn.disabled = false;
                    updateUIToReflectTool();
                }
            }

            function startApp(mode) {
                Tone.start();
                modeSelectionModal.style.display = 'none';
                appContainer.style.display = 'flex';
                setMode(mode);
                init();
                showTutorial();
            }
            
            function startNewQuiz() {
                score = 0;
                currentQuestionIndex = 0;
                questionAnswered = false;
                practiceModeBtn.disabled = true;
                quizSessionMolecules = quizMolecules.sort(() => 0.5 - Math.random()).slice(0, 5);
                loadNextMolecule();
            }

            function loadNextMolecule() {
                if (currentQuestionIndex >= quizSessionMolecules.length) {
                    appContainer.style.display = 'none';
                    modalTitle.textContent = "Quiz Complete!";
                    modalText.textContent = `Your final score is ${score} out of 5. Would you like to try another quiz or go to practice mode?`;
                    modalQuizBtn.textContent = "Another Quiz";
                    modeSelectionModal.style.display = 'flex';
                    practiceModeBtn.disabled = false;
                    return;
                }
                const molecule = quizSessionMolecules[currentQuestionIndex];
                currentQuizMolecule = molecule;
                questionAnswered = false;
                resetCanvas();
                updateUIToReflectTool();
                nextMoleculeBtn.textContent = "Next Question";
            }

            function resetCanvas() {
                placedAtoms = [];
                placedBonds = [];
                drawCanvas();
                saveState();
            }

            function checkStructure() {
                if (questionAnswered && currentMode === 'quiz') return;
                
                clearFeedback();

                if (placedAtoms.length === 0) {
                    showFeedback(["The canvas is empty. Please draw a molecule before checking."], "error");
                    return;
                }

                let errors = [];
                
                if (currentMode === 'quiz') {
                    const drawnFormula = getFormula(placedAtoms);
                    const quizFormula = getFormulaFromString(currentQuizMolecule);
                    if (drawnFormula !== quizFormula) {
                         errors.push(`You have drawn the wrong molecule. The question asks for ${currentQuizMolecule}, but you have drawn ${drawnFormula}.`);
                    }
                }
                
                const atomCounts = {};
                placedAtoms.forEach(atom => {
                    atomCounts[atom.symbol] = (atomCounts[atom.symbol] || 0) + 1;
                });

                let requiredValence = 0;
                placedAtoms.forEach(atom => requiredValence += valenceElectrons[atom.symbol]);

                let drawnElectrons = 0;
                placedBonds.forEach(bond => drawnElectrons += bond.type * 2);
                placedAtoms.forEach(atom => drawnElectrons += atom.lonePairs.length * 2);
                
                if (requiredValence !== drawnElectrons) {
                    errors.push(`The total number of valence electrons is incorrect. Your structure has ${drawnElectrons}, but it should have ${requiredValence} based on the atoms used.`);
                }

                placedAtoms.forEach(atom => {
                    let electronsAroundAtom = atom.lonePairs.length * 2;
                    placedBonds.forEach(bond => {
                        if (bond.start === atom || bond.end === atom) {
                            electronsAroundAtom += bond.type * 2;
                        }
                    });

                    const errorPrefix = (atomCounts[atom.symbol] > 1) ? `One of your ${atom.symbol} atoms` : `The ${atom.symbol} atom`;
                    const rule = octetRules[atom.symbol];
                    let isValid = false;
                    let ruleDescription = 'the octet rule (8 electrons)';

                    if (rule) {
                        if (rule.type === 'exact') {
                            isValid = electronsAroundAtom === rule.value;
                            ruleDescription = `the ${rule.name} (${rule.value} electrons)`;
                        } else if (rule.type === 'expanded') {
                            isValid = rule.values.includes(electronsAroundAtom);
                            ruleDescription = `a valid state (${rule.values.join(' or ')} electrons)`;
                        }
                    } else {
                        isValid = electronsAroundAtom === 8;
                    }

                    if (!isValid) {
                        errors.push(`${errorPrefix} is incorrect. It should follow ${ruleDescription}, but this one has ${electronsAroundAtom}.`);
                    }
                });

                if (errors.length === 0) {
                    correctSound.triggerAttackRelease("C5", "0.5s");
                    if (currentMode === 'quiz' && !questionAnswered) {
                        score++;
                        questionAnswered = true;
                    }
                    
                    if (currentMode === 'quiz' && currentQuestionIndex === quizSessionMolecules.length - 1) {
                        showFeedback(["Excellent! You've completed the quiz!"], "success");
                        triggerConfetti();
                    } else {
                        showFeedback(["Correct! Great job!"], "success");
                    }
                } else {
                    wrongSound.triggerAttackRelease("C2", "0.5s");
                    if (currentMode === 'quiz' && !questionAnswered) {
                         questionAnswered = true;
                    }
                    showFeedback(errors, "error");
                }
                
                if(currentMode === 'quiz') updateUIToReflectTool();
            }
            
            // --- UI & Feedback Functions ---
            function showFeedback(messages, type) {
                let feedbackHTML = '';
                if (type === 'success') {
                    feedbackHTML = `<h4>Validation Successful!</h4><p>${messages[0]}</p>`;
                    feedbackArea.classList.add('success');
                } else {
                    feedbackHTML = '<h4>Please fix the following issues:</h4><ul>';
                    messages.forEach(msg => {
                        feedbackHTML += `<li>${msg}</li>`;
                    });
                    feedbackHTML += '</ul>';
                    feedbackArea.classList.add('error');
                }
                instructions.innerHTML = feedbackHTML;
            }

            function clearFeedback() {
                if (feedbackArea.classList.contains('success') || feedbackArea.classList.contains('error')) {
                     feedbackArea.classList.remove('success', 'error');
                     updateUIToReflectTool(true);
                }
            }

            function updateUIToReflectTool(forceUpdate = false) {
                bondToolBtn.classList.toggle('active', currentTool === 'bond');
                electronToolBtn.classList.toggle('active', currentTool === 'electron');
                canvas.classList.toggle('tool-active', currentTool !== 'none');
                
                const isShowingFeedback = feedbackArea.classList.contains('success') || feedbackArea.classList.contains('error');
                
                if (!isShowingFeedback || forceUpdate) {
                    if (currentMode === 'quiz') {
                        feedbackArea.classList.add('quiz-mode-instructions');
                        questionCounter.textContent = `Question: ${currentQuestionIndex + 1} / 5`;
                        scoreCounter.textContent = `Score: ${score} / 5`;
                        instructions.innerHTML = `<div id="quiz-question-area">Draw the Lewis structure for: <span>${formatFormulaHTML(quizSessionMolecules[currentQuestionIndex])}</span></div>`;
                    } else {
                        feedbackArea.classList.remove('quiz-mode-instructions');
                        let text = "Instructions: Drag an atom from the toolbox and drop it onto the canvas.";
                        if (currentTool === 'bond') {
                            text = "Bond Tool: Click and drag between atoms. Click an existing bond to change its type.";
                        } else if (currentTool === 'electron') {
                            text = "Electron Tool: Click on an atom to add a lone pair.";
                        }
                        instructions.innerHTML = `<p>${text}</p>`;
                    }
                }
            }
            
            function showTutorial() {
                tutorialPanel.classList.add('visible');
                setTimeout(() => {
                    hideTutorial();
                }, 10000); // Hide after 10 seconds
            }

            function hideTutorial() {
                tutorialPanel.classList.remove('visible');
            }
            
            // --- Helper Functions ---
            function formatFormulaHTML(formulaStr) {
                return formulaStr.replace(/(\d+)/g, '<sub>$1</sub>');
            }

            function getFormula(atoms) {
                if (!atoms || atoms.length === 0) return '';
                const counts = {};
                atoms.forEach(atom => {
                    counts[atom.symbol] = (counts[atom.symbol] || 0) + 1;
                });
                return Object.keys(counts).sort().map(key => key + (counts[key] > 1 ? counts[key] : '')).join('');
            }

            function getFormulaFromString(formulaStr) {
                const counts = {};
                const regex = /([A-Z][a-z]?)(\d*)/g;
                let match;
                while ((match = regex.exec(formulaStr)) !== null) {
                    const element = match[1];
                    const count = match[2] ? parseInt(match[2], 10) : 1;
                    counts[element] = (counts[element] || 0) + count;
                }
                return Object.keys(counts).sort().map(key => key + (counts[key] > 1 ? counts[key] : '')).join('');
            }
            
            function triggerConfetti() {
                for (let i = 0; i < 100; i++) {
                    const confetti = document.createElement('div');
                    confetti.classList.add('confetti');
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.animationDelay = Math.random() * 2 + 's';
                    confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    confettiContainer.appendChild(confetti);
                    setTimeout(() => {
                        confetti.remove();
                    }, 5000);
                }
            }
            
            function showCorrectAnswer() {
                 if (currentMode === 'quiz') {
                    if (!questionAnswered) {
                        wrongSound.triggerAttackRelease("C2", "0.5s");
                        questionAnswered = true;
                    }
                    showFeedback(["Here is the correct answer. Click 'Next Question' to continue."], "error");
                    
                    const answer = answerKey[currentQuizMolecule];
                    if (!answer) return;

                    resetCanvas();
                    
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    const radius = 100;

                    const tempAtoms = answer.atoms.map((atomData, index) => {
                        let x, y;
                        if (index === 0) { // Central atom
                            x = centerX;
                            y = centerY;
                        } else {
                            const angle = (2 * Math.PI * (index - 1)) / (answer.atoms.length - 1);
                            x = centerX + radius * Math.cos(angle);
                            y = centerY + radius * Math.sin(angle);
                        }
                        const lonePairs = Array(atomData.lp).fill({});
                        return { symbol: atomData.s, x, y, lonePairs };
                    });
                    
                    placedAtoms = tempAtoms;

                    const tempBonds = answer.bonds.map(bondData => {
                        return {
                            start: placedAtoms[bondData.s],
                            end: placedAtoms[bondData.e],
                            type: bondData.t
                        };
                    });
                    
                    placedBonds = tempBonds;

                    drawCanvas();
                    saveState();
                    updateUIToReflectTool();
                 }
            }

            // --- Event Listeners ---
            modalPracticeBtn.addEventListener('click', () => startApp('practice'));
            modalQuizBtn.addEventListener('click', () => startApp('quiz'));
            practiceModeBtn.addEventListener('click', () => setMode('practice'));
            quizModeBtn.addEventListener('click', () => setMode('quiz'));
            nextMoleculeBtn.addEventListener('click', () => {
                if(nextMoleculeBtn.textContent === 'Restart Quiz') {
                    startNewQuiz();
                } else {
                    currentQuestionIndex++;
                    loadNextMolecule();
                }
            });
            bondToolBtn.addEventListener('click', () => setTool('bond'));
            electronToolBtn.addEventListener('click', () => setTool('electron'));
            resetBtn.addEventListener('click', resetCanvas);
            checkBtn.addEventListener('click', checkStructure);
            showAnswerBtn.addEventListener('click', showCorrectAnswer);
            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);
            closeTutorialBtn.addEventListener('click', hideTutorial);

            function getCoords(event) {
                let x, y;
                const rect = canvas.getBoundingClientRect();
                if (event.touches && event.touches.length > 0) {
                    x = event.touches[0].clientX - rect.left;
                    y = event.touches[0].clientY - rect.top;
                } else if (event.changedTouches && event.changedTouches.length > 0) {
                    x = event.changedTouches[0].clientX - rect.left;
                    y = event.changedTouches[0].clientY - rect.top;
                } else {
                    x = event.clientX - rect.left;
                    y = event.clientY - rect.top;
                }
                return { x, y };
            }

            function handleDown(event) {
                event.preventDefault();
                const { x, y } = getCoords(event);
                let stateChanged = false;

                if (currentTool === 'bond') {
                    const clickedAtom = getAtomAt(x, y);
                    if (clickedAtom) {
                        isBonding = true;
                        bondStartAtom = clickedAtom;
                    } else {
                        const clickedBond = getBondAt(x, y);
                        if (clickedBond) {
                            clickedBond.type = (clickedBond.type % 3) + 1;
                            stateChanged = true;
                        }
                    }
                } else if (currentTool === 'electron') {
                    const clickedAtom = getAtomAt(x, y);
                    if (clickedAtom) {
                        if (clickedAtom.lonePairs.length < 4) { clickedAtom.lonePairs.push({}); } 
                        else { clickedAtom.lonePairs = []; }
                        stateChanged = true;
                    }
                }
                if (stateChanged) { drawCanvas(); saveState(); }
            }

            function handleMove(event) {
                if (!isBonding || !bondStartAtom) return;
                event.preventDefault();
                drawCanvas();
                const { x, y } = getCoords(event);
                ctx.beginPath();
                ctx.strokeStyle = '#6c757d';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.moveTo(bondStartAtom.x, bondStartAtom.y);
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            function handleUp(event) {
                if (!isBonding || !bondStartAtom) return;
                event.preventDefault();
                const { x, y } = getCoords(event);
                const endAtom = getAtomAt(x, y);
                let stateChanged = false;
                if (endAtom && endAtom !== bondStartAtom) {
                    const bondExists = placedBonds.some(b => (b.start === bondStartAtom && b.end === endAtom) || (b.start === endAtom && b.end === bondStartAtom));
                    if (!bondExists) {
                        placedBonds.push({ start: bondStartAtom, end: endAtom, type: 1 });
                        stateChanged = true;
                    }
                }
                isBonding = false;
                bondStartAtom = null;
                drawCanvas();
                if (stateChanged) { saveState(); }
            }
            
            canvas.addEventListener('mousedown', handleDown);
            canvas.addEventListener('mousemove', handleMove);
            canvas.addEventListener('mouseup', handleUp);
            canvas.addEventListener('touchstart', handleDown);
            canvas.addEventListener('touchmove', handleMove);
            canvas.addEventListener('touchend', handleUp);

            function getAtomAt(x, y) {
                let closestAtom = null;
                let minDistance = 25;
                for (let i = placedAtoms.length - 1; i >= 0; i--) {
                    const atom = placedAtoms[i];
                    const distance = Math.sqrt((x - atom.x)**2 + (y - atom.y)**2);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestAtom = atom;
                    }
                }
                return closestAtom;
            }

            function getBondAt(x, y) {
                const tolerance = 10;
                let closestBond = null;
                let minDistance = Infinity;
                for (const bond of placedBonds) {
                    const { start, end } = bond;
                    if(!start || !end) continue;
                    const dx = end.x - start.x;
                    const dy = end.y - start.y;
                    const lenSq = dx*dx + dy*dy;
                    if (lenSq === 0) continue;
                    let t = ((x - start.x) * dx + (y - start.y) * dy) / lenSq;
                    t = Math.max(0, Math.min(1, t));
                    const closestX = start.x + t * dx;
                    const closestY = start.y + t * dy;
                    const distance = Math.sqrt((x - closestX)**2 + (y - closestY)**2);
                    if (distance < tolerance && distance < minDistance) {
                        minDistance = distance;
                        closestBond = bond;
                    }
                }
                return closestBond;
            }
            
            atomButtons.forEach(button => {
                button.addEventListener('dragstart', (event) => {
                    event.dataTransfer.setData('text/plain', event.target.dataset.atom);
                    event.dataTransfer.effectAllowed = 'copy';
                });
            });

            canvas.addEventListener('dragover', (event) => event.preventDefault());

            canvas.addEventListener('drop', (event) => {
                event.preventDefault();
                const atomSymbol = event.dataTransfer.getData('text/plain');
                if (!atomSymbol) return;
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                placedAtoms.push({ symbol: atomSymbol, x, y, lonePairs: [] });
                drawCanvas();
                saveState();
            });

            // --- Initial Setup ---
            function init() {
                resizeCanvas();
                saveState();
                updateHistoryButtons();
            }
        });
    </script>

</body>
</html>
