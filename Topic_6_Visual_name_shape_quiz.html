<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Name that Shape! Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.156.1/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.156.1/examples/jsm/"
        }
    }
    </script>
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .btn-answer {
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .btn-answer:hover:not(:disabled) {
            transform: translateY(-4px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .btn-correct {
            background-color: #16a34a !important;
            border-color: #bbf7d0 !important;
            color: white !important;
        }
        .btn-incorrect {
            background-color: #dc2626 !important;
            border-color: #fecaca !important;
            color: white !important;
        }
        #timer-bar {
            transition: width 1s linear;
        }
        #canvas-container {
            min-height: 250px;
            height: 40vh;
            max-height: 500px;
            cursor: grab;
        }
        #canvas-container:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-4">

    <div id="quiz-container" class="w-full max-w-2xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 text-white">

        <!-- Start Screen -->
        <div id="start-screen" class="text-center">
            <h1 class="text-4xl font-black text-purple-300 uppercase tracking-wider">Visual Shape Quiz</h1>
            <p class="text-gray-400 mt-4 text-lg">Identify the molecular geometry from the 3D model.</p>
            <p class="text-gray-500 mt-2">You'll have 15 seconds for each question.</p>
            <button id="start-btn" class="mt-8 w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-xl transition-transform duration-200 hover:scale-105">
                Start Quiz
            </button>
        </div>

        <!-- Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <!-- Header: Score and Timer -->
            <div class="flex justify-between items-center mb-4">
                <div>
                    <span class="text-gray-400">Score: </span>
                    <span id="score" class="text-2xl font-bold">0</span>
                </div>
                <div class="flex items-center justify-center bg-gray-700 rounded-full w-16 h-16 border-4 border-gray-600">
                    <span id="timer" class="text-2xl font-bold">15</span>
                </div>
            </div>
            
            <!-- Timer Bar -->
            <div class="w-full bg-gray-700 rounded-full h-2.5 mb-4">
              <div id="timer-bar" class="bg-purple-500 h-2.5 rounded-full" style="width: 100%"></div>
            </div>

            <!-- 3D Canvas -->
            <div id="canvas-container" class="bg-gray-900 rounded-lg mb-4">
                <!-- Three.js canvas will be inserted here -->
            </div>

            <!-- Answers -->
            <div id="answer-buttons" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Buttons will be generated by JS -->
            </div>
        </div>

        <!-- End Screen -->
        <div id="end-screen" class="hidden text-center">
            <h1 id="end-title" class="text-4xl font-black text-purple-300">Quiz Complete!</h1>
            <p class="text-gray-400 mt-4 text-xl">Your final score is:</p>
            <p id="final-score" class="text-8xl font-black my-6">0</p>
            <button id="play-again-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg text-xl transition-transform duration-200 hover:scale-105">
                Play Again
            </button>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 3D Scene Variables ---
        let scene, camera, renderer, controls;
        let moleculeGroup = new THREE.Group();
        const canvasContainer = document.getElementById('canvas-container');

        // --- Quiz Data ---
        const quizData = [
            { name: 'Methane', bonding: 4, lone: 0, options: ['Linear', 'V-shaped', 'Trigonal Planar', 'Tetrahedral'], answer: 'Tetrahedral' },
            { name: 'Water', bonding: 2, lone: 2, options: ['Linear', 'V-shaped', 'Trigonal Pyramidal', 'Tetrahedral'], answer: 'V-shaped' },
            { name: 'Ammonia', bonding: 3, lone: 1, options: ['Trigonal Planar', 'Tetrahedral', 'Trigonal Pyramidal', 'V-shaped'], answer: 'Trigonal Pyramidal' },
            { name: 'Carbon Dioxide', bonding: 2, lone: 0, options: ['Linear', 'V-shaped', 'Tetrahedral', 'Octahedral'], answer: 'Linear' },
            { name: 'Boron Trifluoride', bonding: 3, lone: 0, options: ['Trigonal Pyramidal', 'V-shaped', 'Trigonal Planar', 'Tetrahedral'], answer: 'Trigonal Planar' },
            { name: 'Phosphorus Pentachloride', bonding: 5, lone: 0, options: ['Octahedral', 'Trigonal Bipyramidal', 'Trigonal Pyramidal', 'Tetrahedral'], answer: 'Trigonal Bipyramidal' },
            { name: 'Sulfur Hexafluoride', bonding: 6, lone: 0, options: ['Trigonal Bipyramidal', 'Octahedral', 'Trigonal Planar', 'V-shaped'], answer: 'Octahedral' }
        ];

        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const endScreen = document.getElementById('end-screen');
        const startBtn = document.getElementById('start-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const timerBarEl = document.getElementById('timer-bar');
        const answerButtonsEl = document.getElementById('answer-buttons');
        const finalScoreEl = document.getElementById('final-score');
        const endTitleEl = document.getElementById('end-title');

        // --- State Variables ---
        let currentQuestionIndex, score, timer, timerInterval;

        // --- 3D Functions ---
        function init3D() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1f2937);
            scene.add(moleculeGroup);

            camera = new THREE.PerspectiveCamera(75, canvasContainer.clientWidth / canvasContainer.clientHeight, 0.1, 1000);
            camera.position.z = 7;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            canvasContainer.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
            directionalLight.position.set(5, 10, 7.5);
            scene.add(directionalLight);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.1;
            controls.enablePan = false;
            
            window.addEventListener('resize', onWindowResize, false);
            animate();
        }

        function onWindowResize() {
            camera.aspect = canvasContainer.clientWidth / canvasContainer.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvasContainer.clientWidth, canvasContainer.clientHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        const centralAtomMaterial = new THREE.MeshPhongMaterial({ color: 0x9333ea });
        const bondingAtomMaterial = new THREE.MeshPhongMaterial({ color: 0xfbbf24 });
        const bondMaterial = new THREE.MeshBasicMaterial({ color: 0x6b7280 });

        function createAtom(material, radius = 0.5) {
            const geometry = new THREE.SphereGeometry(radius, 32, 32);
            return new THREE.Mesh(geometry, material);
        }

        function createBond(point1, point2) {
            const direction = new THREE.Vector3().subVectors(point2, point1);
            const orientation = new THREE.Matrix4();
            orientation.lookAt(point1, point2, new THREE.Object3D().up);
            orientation.multiply(new THREE.Matrix4().makeRotationX(Math.PI / 2));
            const geometry = new THREE.CylinderGeometry(0.08, 0.08, direction.length(), 8, 1);
            const bond = new THREE.Mesh(geometry, bondMaterial);
            bond.applyMatrix4(orientation);
            bond.position.copy(point1).add(direction.multiplyScalar(0.5));
            return bond;
        }

        function getPositions(total, lone) {
            const positions = [];
            const bondDist = 2.0;

            switch (total) {
                case 2:
                    positions.push(new THREE.Vector3(bondDist, 0, 0), new THREE.Vector3(-bondDist, 0, 0));
                    break;
                case 3:
                    for (let i = 0; i < 3; i++) positions.push(new THREE.Vector3(bondDist * Math.cos(i * 2 * Math.PI / 3), bondDist * Math.sin(i * 2 * Math.PI / 3), 0));
                    break;
                case 4:
                    positions.push(new THREE.Vector3(1, 1, 1), new THREE.Vector3(1, -1, -1), new THREE.Vector3(-1, 1, -1), new THREE.Vector3(-1, -1, 1));
                    positions.forEach(p => p.normalize().multiplyScalar(bondDist));
                    break;
                case 5:
                    const axial_tbp = [new THREE.Vector3(0, bondDist, 0), new THREE.Vector3(0, -bondDist, 0)];
                    const equatorial_tbp = [];
                    for (let i = 0; i < 3; i++) equatorial_tbp.push(new THREE.Vector3(bondDist * Math.cos(i * 2 * Math.PI / 3), 0, bondDist * Math.sin(i * 2 * Math.PI / 3)));
                    return [...equatorial_tbp, ...axial_tbp];
                case 6:
                    const axial_oh = [new THREE.Vector3(0, bondDist, 0), new THREE.Vector3(0, -bondDist, 0)];
                    const equatorial_oh = [new THREE.Vector3(bondDist, 0, 0), new THREE.Vector3(-bondDist, 0, 0), new THREE.Vector3(0, 0, bondDist), new THREE.Vector3(0, 0, -bondDist)];
                    return [...axial_oh, ...equatorial_oh];
            }
            return positions;
        }

        function drawMolecule(bonding, lone) {
            while (moleculeGroup.children.length) {
                moleculeGroup.remove(moleculeGroup.children[0]);
            }
            const centralAtom = createAtom(centralAtomMaterial, 0.6);
            moleculeGroup.add(centralAtom);

            const totalPairs = bonding + lone;
            const positions = getPositions(totalPairs, lone);
            
            for (let i = lone; i < totalPairs; i++) {
                 if(positions[i]) {
                    const pos = positions[i];
                    const bondingAtom = createAtom(bondingAtomMaterial);
                    bondingAtom.position.copy(pos);
                    moleculeGroup.add(bondingAtom);
                    const bond = createBond(new THREE.Vector3(0, 0, 0), pos);
                    moleculeGroup.add(bond);
                }
            }
            if(controls) controls.reset();
        }

        // --- Quiz Functions ---
        function startQuiz() {
            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');

            if (!renderer) init3D();

            currentQuestionIndex = 0;
            score = 0;
            scoreEl.textContent = score;
            
            quizData.sort(() => Math.random() - 0.5);
            showQuestion();
        }

        function showQuestion() {
            resetState();
            const q = quizData[currentQuestionIndex];
            drawMolecule(q.bonding, q.lone);
            
            answerButtonsEl.innerHTML = '';
            q.options.sort(() => Math.random() - 0.5).forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'btn-answer w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-lg';
                button.addEventListener('click', () => selectAnswer(button, q));
                answerButtonsEl.appendChild(button);
            });

            startTimer();
        }

        function startTimer() {
            timer = 15;
            timerEl.textContent = timer;
            timerBarEl.style.width = '100%';
            timerBarEl.style.backgroundColor = '#a855f7';

            timerInterval = setInterval(() => {
                timer--;
                timerEl.textContent = timer;
                timerBarEl.style.width = `${(timer / 15) * 100}%`;
                if (timer < 6) timerBarEl.style.backgroundColor = '#facc15';
                if (timer < 3) timerBarEl.style.backgroundColor = '#ef4444';
                if (timer === 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 1000);
        }

        function handleTimeout() {
            const correctAnswer = quizData[currentQuestionIndex].answer;
            Array.from(answerButtonsEl.children).forEach(button => {
                if (button.textContent === correctAnswer) button.classList.add('btn-correct');
                button.disabled = true;
            });
            setTimeout(nextQuestion, 2000);
        }

        function selectAnswer(selectedButton, question) {
            clearInterval(timerInterval);
            const correctAnswer = question.answer;

            Array.from(answerButtonsEl.children).forEach(button => {
                button.disabled = true;
                if (button.textContent === correctAnswer) button.classList.add('btn-correct');
            });

            if (selectedButton.textContent === correctAnswer) {
                score++;
                scoreEl.textContent = score;
            } else {
                selectedButton.classList.add('btn-incorrect');
            }
            setTimeout(nextQuestion, 1200);
        }
        
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                showQuestion();
            } else {
                endQuiz();
            }
        }

        function resetState() {
            clearInterval(timerInterval);
        }
        
        function triggerConfetti() {
            const duration = 2 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

            function randomInRange(min, max) {
              return Math.random() * (max - min) + min;
            }

            const interval = setInterval(function() {
              const timeLeft = animationEnd - Date.now();

              if (timeLeft <= 0) {
                return clearInterval(interval);
              }

              const particleCount = 50 * (timeLeft / duration);
              // since particles fall down, start a bit higher than random
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
              confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        function endQuiz() {
            quizScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            finalScoreEl.textContent = score;
            
            // Add confetti for a perfect score
            if (score === quizData.length) {
                endTitleEl.textContent = 'Perfect Score!';
                finalScoreEl.classList.add('text-green-400');
                triggerConfetti();
            } else {
                endTitleEl.textContent = 'Quiz Complete!';
                finalScoreEl.classList.remove('text-green-400');
            }
        }

        // --- Event Listeners ---
        startBtn.addEventListener('click', startQuiz);
        playAgainBtn.addEventListener('click', startQuiz);

    </script>
</body>
</html>
