<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collision Runner PRO - Rate of Reaction</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel for in-browser JSX -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'JetBrains+Mono', monospace; }
        canvas { filter: drop-shadow(0 0 8px rgba(0,0,0,0.5)); }
    </style>
</head>
<body class="bg-slate-950 text-white overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const SCENARIOS = {
            STANDARD: {
                label: 'Standard',
                particleCount: 15,
                baseEnergy: 1,
                efficiency: 1.0,
                color: '#94a3b8',
                description: 'Room temperature (25°C) and 1.0M concentration.'
            },
            HIGH_TEMP: {
                label: 'High Temp',
                particleCount: 15,
                baseEnergy: 2.5,
                efficiency: 1.6,
                color: '#fb7185',
                description: 'Higher kinetic energy. More effective collisions.'
            },
            HIGH_CONC: {
                label: 'High Conc',
                particleCount: 35,
                baseEnergy: 1,
                efficiency: 1.3,
                color: '#38bdf8',
                description: 'Higher density = higher collision frequency.'
            }
        };

        // Custom SVG Chart Component for better performance and browser compatibility
        const SparkChart = ({ data, analysisIndex, setAnalysisIndex, isAnalysis }) => {
            const width = 800;
            const height = 400;
            const padding = 40;

            const getX = (t) => (t / 15) * (width - padding * 2) + padding;
            const getY = (v) => height - padding - (v / 100) * (height - padding * 2);

            const p1Path = data.map((d, i) => `${i === 0 ? 'M' : 'L'} ${getX(d.t)} ${getY(d.p1)}`).join(' ');
            const p2Path = data.map((d, i) => `${i === 0 ? 'M' : 'L'} ${getX(d.t)} ${getY(d.p2)}`).join(' ');

            const handleMouseMove = (e) => {
                if (!isAnalysis) return;
                const svg = e.currentTarget;
                const rect = svg.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const t = ((x - padding) / (width - padding * 2)) * 15;
                const closestIndex = data.reduce((prev, curr, idx) => 
                    Math.abs(curr.t - t) < Math.abs(data[prev].t - t) ? idx : prev, 0);
                setAnalysisIndex(closestIndex);
            };

            return (
                <svg 
                    viewBox={`0 0 ${width} ${height}`} 
                    className="w-full h-full cursor-crosshair touch-none"
                    onMouseMove={handleMouseMove}
                >
                    {/* Grid Lines */}
                    {[0, 25, 50, 75, 100].map(v => (
                        <g key={v}>
                            <line x1={padding} y1={getY(v)} x2={width - padding} y2={getY(v)} stroke="#1e293b" strokeWidth="1" />
                            <text x={padding - 10} y={getY(v) + 4} textAnchor="end" fill="#475569" fontSize="12">{v}</text>
                        </g>
                    ))}
                    {/* Axes */}
                    <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#475569" strokeWidth="2" />
                    <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#475569" strokeWidth="2" />
                    
                    {/* Data Lines */}
                    <path d={p1Path} fill="none" stroke="#3b82f6" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" />
                    <path d={p2Path} fill="none" stroke="#10b981" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round" />

                    {/* Analysis Indicator */}
                    {isAnalysis && data[analysisIndex] && (
                        <g>
                            <line x1={getX(data[analysisIndex].t)} y1={padding} x2={getX(data[analysisIndex].t)} y2={height - padding} stroke="#f59e0b" strokeDasharray="4 4" />
                            <circle cx={getX(data[analysisIndex].t)} cy={getY(data[analysisIndex].p1)} r="6" fill="#3b82f6" />
                            <circle cx={getX(data[analysisIndex].t)} cy={getY(data[analysisIndex].p2)} r="6" fill="#10b981" />
                        </g>
                    )}
                </svg>
            );
        };

        const ReactionChamber = ({ tapPulse, color, playerLabel, scenario }) => {
            const canvasRef = useRef(null);
            const particles = useRef([]);
            const requestRef = useRef();

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const { particleCount, baseEnergy } = SCENARIOS[scenario];
                
                particles.current = Array.from({ length: particleCount }, () => ({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    vx: (Math.random() - 0.5) * 3,
                    vy: (Math.random() - 0.5) * 3,
                    radius: 3.5,
                    energy: baseEnergy
                }));

                const animate = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    const currentBaseEnergy = SCENARIOS[scenario].baseEnergy;
                    
                    particles.current.forEach((p, i) => {
                        p.energy = p.energy > currentBaseEnergy ? Math.max(currentBaseEnergy, p.energy * 0.97) : currentBaseEnergy;
                        p.x += p.vx * p.energy;
                        p.y += p.vy * p.energy;

                        if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                        if (p.y < 0 || p.y > canvas.height) p.vy *= -1;

                        particles.current.forEach((p2, j) => {
                            if (i === j) return;
                            const dx = p.x - p2.x, dy = p.y - p2.y, dist = Math.sqrt(dx*dx + dy*dy);
                            if (dist < p.radius + p2.radius) {
                                if (p.energy + p2.energy > 4.5) {
                                    ctx.beginPath();
                                    ctx.arc(p.x, p.y, 10, 0, Math.PI * 2);
                                    ctx.fillStyle = 'rgba(74, 222, 128, 0.3)';
                                    ctx.fill();
                                }
                                p.vx = (dx / dist) * 1.5; p.vy = (dy / dist) * 1.5;
                            }
                        });

                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                        ctx.fillStyle = p.energy > 4 ? '#4ade80' : color;
                        ctx.fill();
                    });
                    requestRef.current = requestAnimationFrame(animate);
                };
                requestRef.current = requestAnimationFrame(animate);
                return () => cancelAnimationFrame(requestRef.current);
            }, [color, scenario]);

            useEffect(() => {
                if (tapPulse > 0) particles.current.forEach(p => p.energy = Math.min(10, p.energy + 2.5));
            }, [tapPulse]);

            return (
                <div className="flex flex-col items-center">
                    <canvas ref={canvasRef} width={160} height={100} className="rounded-xl bg-black/40 border border-white/10" />
                    <span className="text-[9px] font-black opacity-40 uppercase tracking-widest mt-2">{playerLabel} CHAMBER</span>
                </div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState('START');
            const [scenario, setScenario] = useState('STANDARD');
            const [time, setTime] = useState(0);
            const [p1Data, setP1Data] = useState([{ t: 0, v: 0 }]);
            const [p2Data, setP2Data] = useState([{ t: 0, v: 0 }]);
            const [p1Pulse, setP1Pulse] = useState(0);
            const [p2Pulse, setP2Pulse] = useState(0);
            const [analysisIndex, setAnalysisIndex] = useState(0);

            const startTime = useRef(null);
            const p1Taps = useRef(0);
            const p2Taps = useRef(0);
            const timerRef = useRef(null);

            const startRace = () => {
                setGameState('RACING');
                setTime(0);
                setP1Data([{ t: 0, v: 0 }]);
                setP2Data([{ t: 0, v: 0 }]);
                p1Taps.current = 0;
                p2Taps.current = 0;
                startTime.current = Date.now();

                timerRef.current = setInterval(() => {
                    const elapsed = (Date.now() - startTime.current) / 1000;
                    if (elapsed >= 15) {
                        clearInterval(timerRef.current);
                        setGameState('ANALYSIS');
                        return;
                    }
                    setTime(elapsed);

                    const update = (prev, taps) => {
                        const last = prev[prev.length - 1].v;
                        const depletion = (100 - last) / 100;
                        const gain = (SCENARIOS[scenario].baseEnergy * 0.05 + taps.current * 1.5) * SCENARIOS[scenario].efficiency * depletion;
                        taps.current = 0;
                        return [...prev, { t: elapsed, v: Math.min(100, last + gain) }];
                    };

                    setP1Data(p => update(p, p1Taps));
                    setP2Data(p => update(p, p2Taps));
                }, 100);
            };

            const chartData = p1Data.map((d, i) => ({ t: d.t, p1: d.v, p2: p2Data[i]?.v || 0 }));

            const getRate = (data, idx) => {
                if (idx < 2 || idx >= data.length - 2) return "0.00";
                return ((data[idx+2].v - data[idx-2].v) / (data[idx+2].t - data[idx-2].t)).toFixed(2);
            };

            return (
                <div className="max-w-5xl w-full p-6 mx-auto">
                    <header className="flex justify-between items-end mb-8 border-b border-slate-900 pb-6">
                        <div>
                            <div className="text-blue-400 text-[10px] font-black tracking-widest uppercase mb-1">HKDSE Chemistry Lab</div>
                            <h1 className="text-3xl font-black italic">COLLISION RUNNER <span className="text-slate-700 not-italic font-light">PRO</span></h1>
                        </div>
                        <div className="text-right">
                            <div className="text-slate-600 text-[10px] font-black uppercase">Clock</div>
                            <div className="text-3xl font-mono font-black text-blue-500">{time.toFixed(1)}s</div>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        {/* Sidebar */}
                        <div className="lg:col-span-3 space-y-6">
                            {gameState === 'START' && (
                                <div className="bg-slate-900 p-5 rounded-3xl border border-slate-800 shadow-2xl space-y-3">
                                    <h3 className="text-slate-500 uppercase text-[10px] font-black tracking-widest">Environment</h3>
                                    {Object.keys(SCENARIOS).map(k => (
                                        <button key={k} onClick={() => setScenario(k)} className={`w-full p-4 rounded-2xl text-left border transition-all ${scenario === k ? 'bg-blue-600 border-blue-400' : 'bg-slate-800 border-slate-700 hover:border-slate-500'}`}>
                                            <div className="text-xs font-black uppercase">{SCENARIOS[k].label}</div>
                                            <div className="text-[9px] opacity-60 mt-1">{SCENARIOS[k].description}</div>
                                        </button>
                                    ))}
                                </div>
                            )}

                            <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800">
                                <h3 className="text-slate-500 uppercase text-[10px] font-black mb-6 tracking-widest">Instant Rate</h3>
                                <div className="space-y-8">
                                    <div>
                                        <div className="text-blue-400 text-[10px] font-black uppercase mb-1">Player 1</div>
                                        <div className="text-4xl font-mono font-black">{gameState === 'ANALYSIS' ? getRate(p1Data, analysisIndex) : "---"}</div>
                                        <div className="text-[9px] text-slate-600 font-bold mt-1 uppercase">mol dm⁻³ s⁻¹</div>
                                    </div>
                                    <div className="pt-6 border-t border-slate-800">
                                        <div className="text-emerald-400 text-[10px] font-black uppercase mb-1">Player 2</div>
                                        <div className="text-4xl font-mono font-black">{gameState === 'ANALYSIS' ? getRate(p2Data, analysisIndex) : "---"}</div>
                                        <div className="text-[9px] text-slate-600 font-bold mt-1 uppercase">mol dm⁻³ s⁻¹</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Main Content */}
                        <div className="lg:col-span-9 space-y-6">
                            <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-2xl h-[450px]">
                                <div className="flex justify-between items-center mb-4">
                                    <span className="text-[10px] font-black text-slate-500 uppercase tracking-widest">Concentration-Time Curve</span>
                                    {gameState === 'ANALYSIS' && <span className="text-[10px] font-black text-amber-500 uppercase animate-pulse">Analysis Active</span>}
                                </div>
                                <div className="h-full w-full pb-8">
                                    <SparkChart data={chartData} analysisIndex={analysisIndex} setAnalysisIndex={setAnalysisIndex} isAnalysis={gameState === 'ANALYSIS'} />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-6 h-64">
                                {gameState === 'START' ? (
                                    <button onClick={startRace} className="col-span-2 bg-blue-600 rounded-3xl flex flex-col items-center justify-center gap-2 hover:bg-blue-500 transition-all shadow-xl shadow-blue-900/40 uppercase font-black tracking-widest">
                                        <div className="w-16 h-16 rounded-full bg-white flex items-center justify-center mb-2">
                                            <svg className="w-8 h-8 fill-blue-600 ml-1" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                        </div>
                                        Start Lab
                                    </button>
                                ) : gameState === 'RACING' ? (
                                    <>
                                        <button 
                                            onMouseDown={() => { p1Taps.current++; setP1Pulse(p => p + 1); }} 
                                            onTouchStart={(e) => { e.preventDefault(); p1Taps.current++; setP1Pulse(p => p + 1); }} 
                                            className="bg-slate-900 rounded-3xl border-b-[10px] border-blue-900 active:border-b-0 active:translate-y-2 transition-all flex flex-col items-center justify-center touch-none"
                                        >
                                            <ReactionChamber tapPulse={p1Pulse} color="#3b82f6" playerLabel="P1" scenario={scenario} />
                                        </button>
                                        <button 
                                            onMouseDown={() => { p2Taps.current++; setP2Pulse(p => p + 1); }} 
                                            onTouchStart={(e) => { e.preventDefault(); p2Taps.current++; setP2Pulse(p => p + 1); }} 
                                            className="bg-slate-900 rounded-3xl border-b-[10px] border-emerald-900 active:border-b-0 active:translate-y-2 transition-all flex flex-col items-center justify-center touch-none"
                                        >
                                            <ReactionChamber tapPulse={p2Pulse} color="#10b981" playerLabel="P2" scenario={scenario} />
                                        </button>
                                    </>
                                ) : (
                                    <div className="col-span-2 bg-slate-900 rounded-3xl border-2 border-dashed border-slate-800 flex flex-col items-center justify-center p-6 text-center">
                                        <h4 className="text-xl font-black uppercase text-white">Results Ready</h4>
                                        <p className="text-slate-500 text-xs mt-2">Move cursor over the graph to calculate instantaneous slopes.</p>
                                        <button onClick={() => setGameState('START')} className="mt-6 px-10 py-3 bg-white text-slate-950 rounded-full text-xs font-black uppercase tracking-widest hover:bg-blue-400">Restart Experiment</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>