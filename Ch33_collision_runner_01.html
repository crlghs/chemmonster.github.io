import React, { useState, useEffect, useRef, useMemo } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, ReferenceLine } from 'recharts';
import { Activity, Zap, Play, RotateCcw, ChevronRight, BarChart3, Info, FlaskConical, Thermometer, Users } from 'lucide-react';

// Configuration for different scenarios
const SCENARIOS = {
  STANDARD: {
    label: 'Standard',
    particleCount: 15,
    baseEnergy: 1,
    efficiency: 1.0,
    color: '#94a3b8',
    description: 'Room temperature (25°C) and 1.0M concentration.'
  },
  HIGH_TEMP: {
    label: 'High Temp',
    particleCount: 15,
    baseEnergy: 2.5,
    efficiency: 1.6,
    color: '#fb7185',
    description: 'Particles have higher kinetic energy. More collisions are "Effective".'
  },
  HIGH_CONC: {
    label: 'High Conc',
    particleCount: 35,
    baseEnergy: 1,
    efficiency: 1.3,
    color: '#38bdf8',
    description: 'Higher collision frequency due to crowded reactant particles.'
  }
};

// Particle System Component for the "Micro-View"
const ReactionChamber = ({ isRacing, tapPulse, color, playerLabel, scenario }) => {
  const canvasRef = useRef(null);
  const particles = useRef([]);
  const requestRef = useRef();
  
  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const { particleCount, baseEnergy } = SCENARIOS[scenario];
    
    particles.current = Array.from({ length: particleCount }, () => ({
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height,
      vx: (Math.random() - 0.5) * 2,
      vy: (Math.random() - 0.5) * 2,
      radius: 3.5,
      energy: baseEnergy,
      lastCollision: 0
    }));

    const animate = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const currentBaseEnergy = SCENARIOS[scenario].baseEnergy;
      
      particles.current.forEach((p, i) => {
        p.energy = p.energy > currentBaseEnergy 
          ? Math.max(currentBaseEnergy, p.energy * 0.98) 
          : currentBaseEnergy;
        
        p.x += p.vx * p.energy;
        p.y += p.vy * p.energy;

        if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
        if (p.y < 0 || p.y > canvas.height) p.vy *= -1;

        particles.current.forEach((p2, j) => {
          if (i === j) return;
          const dx = p.x - p2.x;
          const dy = p.y - p2.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          
          if (dist < p.radius + p2.radius) {
            const combinedEnergy = p.energy + p2.energy;
            const isEffective = combinedEnergy > 4.5;
            p.vx = (dx / dist) * 1.5;
            p.vy = (dy / dist) * 1.5;
            
            if (isEffective) {
              ctx.beginPath();
              ctx.arc(p.x, p.y, 10, 0, Math.PI * 2);
              ctx.fillStyle = 'rgba(74, 222, 128, 0.4)';
              ctx.fill();
            }
          }
        });

        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fillStyle = p.energy > 4 ? '#4ade80' : color;
        ctx.fill();
        
        if (p.energy > 4) {
          ctx.shadowBlur = 8;
          ctx.shadowColor = '#4ade80';
        } else {
          ctx.shadowBlur = 0;
        }
      });
      
      requestRef.current = requestAnimationFrame(animate);
    };

    requestRef.current = requestAnimationFrame(animate);
    return () => cancelAnimationFrame(requestRef.current);
  }, [color, scenario]);

  useEffect(() => {
    if (tapPulse > 0) {
      particles.current.forEach(p => {
        p.energy = Math.min(10, p.energy + 2);
      });
    }
  }, [tapPulse]);

  return (
    <div className="relative w-full h-full flex flex-col items-center justify-center pointer-events-none p-2">
      <canvas 
        ref={canvasRef} 
        width={160} 
        height={100} 
        className="rounded-xl bg-black/40 border border-white/5 shadow-inner"
      />
      <span className="text-[9px] font-black opacity-40 uppercase tracking-widest mt-1">{playerLabel} Chamber</span>
    </div>
  );
};

const App = () => {
  const [gameState, setGameState] = useState('START');
  const [currentScenario, setCurrentScenario] = useState('STANDARD');
  const [time, setTime] = useState(0);
  const [player1Data, setPlayer1Data] = useState([{ t: 0, conc: 0 }]);
  const [player2Data, setPlayer2Data] = useState([{ t: 0, conc: 0 }]);
  const [p1Pulse, setP1Pulse] = useState(0);
  const [p2Pulse, setP2Pulse] = useState(0);
  const [p1CurrentRate, setP1CurrentRate] = useState(0);
  const [p2CurrentRate, setP2CurrentRate] = useState(0);
  const [analysisIndex, setAnalysisIndex] = useState(0);

  const gameLoop = useRef(null);
  const startTime = useRef(null);
  const p1LastTaps = useRef(0);
  const p2LastTaps = useRef(0);

  const MAX_CONC = 100;
  const RACE_DURATION = 15;

  const startRace = () => {
    setGameState('RACING');
    setTime(0);
    setPlayer1Data([{ t: 0, conc: 0 }]);
    setPlayer2Data([{ t: 0, conc: 0 }]);
    startTime.current = Date.now();
    p1LastTaps.current = 0;
    p2LastTaps.current = 0;
    
    gameLoop.current = setInterval(() => {
      const elapsed = (Date.now() - startTime.current) / 1000;
      
      if (elapsed >= RACE_DURATION) {
        clearInterval(gameLoop.current);
        setGameState('ANALYSIS');
        return;
      }

      setTime(elapsed);
      const scenarioConfig = SCENARIOS[currentScenario];
      
      setPlayer1Data(prev => {
        const last = prev[prev.length - 1].conc;
        const depletionFactor = (MAX_CONC - last) / MAX_CONC;
        const baseAutoGain = scenarioConfig.baseEnergy * 0.05; 
        const tapGain = p1LastTaps.current * 1.2;
        const gain = (baseAutoGain + tapGain) * scenarioConfig.efficiency * depletionFactor;
        const newConc = Math.min(MAX_CONC, last + gain);
        setP1CurrentRate((gain * 10).toFixed(2));
        p1LastTaps.current = 0;
        return [...prev, { t: elapsed.toFixed(1), conc: newConc }];
      });

      setPlayer2Data(prev => {
        const last = prev[prev.length - 1].conc;
        const depletionFactor = (MAX_CONC - last) / MAX_CONC;
        const baseAutoGain = scenarioConfig.baseEnergy * 0.05; 
        const tapGain = p2LastTaps.current * 1.2;
        const gain = (baseAutoGain + tapGain) * scenarioConfig.efficiency * depletionFactor;
        const newConc = Math.min(MAX_CONC, last + gain);
        setP2CurrentRate((gain * 10).toFixed(2));
        p2LastTaps.current = 0;
        return [...prev, { t: elapsed.toFixed(1), conc: newConc }];
      });

    }, 100);
  };

  const handleP1Tap = (e) => {
    if (gameState !== 'RACING') return;
    // Prevent default to avoid zooming/scrolling on mobile while mashing
    if (e.type === 'touchstart') e.preventDefault(); 
    p1LastTaps.current += 1;
    setP1Pulse(p => p + 1);
  };

  const handleP2Tap = (e) => {
    if (gameState !== 'RACING') return;
    if (e.type === 'touchstart') e.preventDefault();
    p2LastTaps.current += 1;
    setP2Pulse(p => p + 1);
  };

  const chartData = useMemo(() => player1Data.map((d, i) => ({
    time: d.t,
    p1: d.conc,
    p2: player2Data[i]?.conc || 0
  })), [player1Data, player2Data]);

  const getTangent = (index, dataKey) => {
    if (!chartData[index] || index < 2 || index >= chartData.length - 2) return "0.00";
    const y1 = chartData[index - 2][dataKey];
    const y2 = chartData[index + 2][dataKey];
    const t1 = parseFloat(chartData[index - 2].time);
    const t2 = parseFloat(chartData[index + 2].time);
    return ((y2 - y1) / (t2 - t1)).toFixed(2);
  };

  return (
    <div className="min-h-screen bg-slate-950 text-white font-sans p-4 flex flex-col items-center select-none">
      <header className="w-full max-w-5xl flex justify-between items-end mb-8 border-b border-slate-900 pb-4">
        <div>
          <div className="flex items-center gap-2 text-blue-400 mb-1">
            <FlaskConical size={18} />
            <span className="text-[10px] font-black tracking-[0.3em] uppercase opacity-70">Variable Simulation v1.2</span>
          </div>
          <h1 className="text-3xl font-black tracking-tight flex items-center gap-3">
            COLLISION RUNNER 
            <span className="bg-white/10 px-3 py-1 rounded text-sm font-light text-slate-400">PRO</span>
          </h1>
        </div>
        <div className="text-right">
          <p className="text-slate-500 text-[10px] font-black uppercase mb-1">Timer</p>
          <p className="text-3xl font-mono font-black text-blue-500 tabular-nums">
            {time.toFixed(1)}<span className="text-sm ml-1 text-slate-700">s</span>
          </p>
        </div>
      </header>

      <main className="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-12 gap-6">
        <div className="lg:col-span-3 space-y-4">
          {gameState === 'START' && (
            <div className="bg-slate-900 p-5 rounded-3xl border border-slate-800 shadow-2xl space-y-3">
              <h3 className="text-slate-500 uppercase text-[10px] font-black mb-1 tracking-widest">Environment Setup</h3>
              {Object.keys(SCENARIOS).map(key => (
                <button
                  key={key}
                  onClick={() => setCurrentScenario(key)}
                  className={`w-full p-3 rounded-2xl border transition-all text-left flex items-center gap-3 ${
                    currentScenario === key 
                    ? 'bg-blue-600 border-blue-400 shadow-lg shadow-blue-900/40' 
                    : 'bg-slate-800 border-slate-700 hover:border-slate-500'
                  }`}
                >
                  {key === 'HIGH_TEMP' ? <Thermometer size={16} /> : key === 'HIGH_CONC' ? <Users size={16} /> : <Zap size={16} />}
                  <div>
                    <div className="text-xs font-black uppercase">{SCENARIOS[key].label}</div>
                    <div className="text-[9px] opacity-60 leading-tight mt-0.5">{SCENARIOS[key].description}</div>
                  </div>
                </button>
              ))}
            </div>
          )}

          <div className="bg-slate-900 p-5 rounded-3xl border border-slate-800 shadow-2xl">
            <h3 className="text-slate-500 uppercase text-[10px] font-black mb-4 tracking-widest">Instantaneous Rate</h3>
            <div className="space-y-6">
              <div className="relative">
                <div className="flex justify-between items-center mb-1">
                  <span className="text-blue-400 text-[10px] font-black uppercase">P1 Formation</span>
                  <div className="w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.8)]" />
                </div>
                <div className="text-4xl font-mono font-black tabular-nums">
                  {(gameState === 'RACING' ? p1CurrentRate : getTangent(analysisIndex, 'p1'))}
                </div>
                <div className="text-[10px] text-slate-600 font-bold uppercase mt-1">mol dm⁻³ s⁻¹</div>
              </div>
              <div className="pt-6 border-t border-slate-800/50 relative">
                <div className="flex justify-between items-center mb-1">
                  <span className="text-emerald-400 text-[10px] font-black uppercase">P2 Formation</span>
                  <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]" />
                </div>
                <div className="text-4xl font-mono font-black tabular-nums">
                  {(gameState === 'RACING' ? p2CurrentRate : getTangent(analysisIndex, 'p2'))}
                </div>
                <div className="text-[10px] text-slate-600 font-bold uppercase mt-1">mol dm⁻³ s⁻¹</div>
              </div>
            </div>
          </div>
        </div>

        <div className="lg:col-span-9 space-y-6">
          <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-2xl relative overflow-hidden">
            <div className="absolute top-0 right-0 p-3">
              <div className="flex items-center gap-2 px-3 py-1 bg-slate-800 rounded-full border border-slate-700">
                <div className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: SCENARIOS[currentScenario].color }} />
                <span className="text-[10px] font-black uppercase opacity-60">{SCENARIOS[currentScenario].label} Mode</span>
              </div>
            </div>

            <div className="flex items-center gap-3 mb-8">
              <BarChart3 size={18} className="text-slate-500" />
              <span className="text-xs font-black uppercase tracking-widest text-slate-400">Concentration - Time Plot</span>
            </div>
            
            <div className="h-[340px]">
              <ResponsiveContainer width="100%" height="100%">
                <LineChart 
                  data={chartData}
                  onMouseMove={(e) => {
                    if (gameState === 'ANALYSIS' && e.activeTooltipIndex !== undefined) {
                      setAnalysisIndex(e.activeTooltipIndex);
                    }
                  }}
                >
                  <CartesianGrid strokeDasharray="2 2" stroke="#1e293b" vertical={false} />
                  <XAxis dataKey="time" hide />
                  <YAxis stroke="#475569" fontSize={10} domain={[0, 100]} strokeWidth={0} />
                  <Tooltip 
                    content={({ active, payload }) => {
                      if (active && payload && payload.length) {
                        return (
                          <div className="bg-slate-950 border border-white/10 p-3 rounded-2xl text-[10px] shadow-2xl">
                            <p className="text-slate-500 mb-2 font-black uppercase">Timestamp: {payload[0].payload.time}s</p>
                            <div className="space-y-1.5">
                              <p className="text-blue-400 font-black">P1: {payload[0].value.toFixed(1)} M</p>
                              <p className="text-emerald-400 font-black">P2: {payload[1].value.toFixed(1)} M</p>
                            </div>
                          </div>
                        );
                      }
                      return null;
                    }}
                  />
                  <Line type="monotone" dataKey="p1" stroke="#3b82f6" strokeWidth={5} dot={false} isAnimationActive={false} />
                  <Line type="monotone" dataKey="p2" stroke="#10b981" strokeWidth={5} dot={false} isAnimationActive={false} />
                  {gameState === 'ANALYSIS' && (
                    <ReferenceLine x={chartData[analysisIndex]?.time} stroke="#f59e0b" strokeWidth={2} strokeDasharray="6 6" />
                  )}
                </LineChart>
              </ResponsiveContainer>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-6 h-64">
            {gameState === 'START' ? (
              <button 
                onClick={startRace}
                className="col-span-2 group bg-blue-600 rounded-3xl flex flex-col items-center justify-center gap-4 hover:bg-blue-500 transition-all active:scale-95 shadow-xl shadow-blue-900/20"
              >
                <div className="w-16 h-16 rounded-full bg-white flex items-center justify-center shadow-2xl group-hover:scale-110 transition-transform">
                  <Play fill="#2563eb" size={32} className="ml-1" />
                </div>
                <span className="font-black tracking-widest text-white uppercase text-lg">Ignite Reaction</span>
              </button>
            ) : gameState === 'RACING' ? (
              <>
                <button 
                  onMouseDown={handleP1Tap}
                  onTouchStart={handleP1Tap}
                  className="group relative overflow-hidden bg-slate-900 rounded-3xl border-b-[10px] border-blue-900 active:border-b-0 active:translate-y-2 transition-all flex flex-col items-center justify-center select-none touch-none"
                >
                  <ReactionChamber isRacing={true} tapPulse={p1Pulse} color="#3b82f6" playerLabel="P1" scenario={currentScenario} />
                  <div className="w-full bg-blue-600/10 py-3 mt-auto border-t border-white/5 pointer-events-none">
                    <span className="text-[10px] font-black tracking-widest uppercase text-blue-400">Increase Frequency</span>
                  </div>
                </button>
                <button 
                  onMouseDown={handleP2Tap}
                  onTouchStart={handleP2Tap}
                  className="group relative overflow-hidden bg-slate-900 rounded-3xl border-b-[10px] border-emerald-900 active:border-b-0 active:translate-y-2 transition-all flex flex-col items-center justify-center select-none touch-none"
                >
                  <ReactionChamber isRacing={true} tapPulse={p2Pulse} color="#10b981" playerLabel="P2" scenario={currentScenario} />
                  <div className="w-full bg-emerald-600/10 py-3 mt-auto border-t border-white/5 pointer-events-none">
                    <span className="text-[10px] font-black tracking-widest uppercase text-emerald-400">Increase Frequency</span>
                  </div>
                </button>
              </>
            ) : (
              <div className="col-span-2 bg-slate-900 rounded-3xl border-2 border-dashed border-slate-800 flex flex-col items-center justify-center p-6 text-center">
                <BarChart3 className="text-blue-500 mb-2" size={32} />
                <h4 className="text-xl font-black text-white uppercase tracking-tighter">Analysis Terminal</h4>
                <p className="text-slate-500 text-[10px] max-w-xs mx-auto mt-2 leading-relaxed">
                  The reaction has plateaued. Hover over the curve to verify how the gradient $m$ approached zero as the concentration reached its maximum.
                </p>
                <button 
                  onClick={() => setGameState('START')} 
                  className="mt-6 px-10 py-3 bg-white text-slate-950 rounded-full text-xs font-black uppercase tracking-widest hover:bg-blue-400 transition-colors shadow-lg"
                >
                  Setup New Experiment
                </button>
              </div>
            )}
          </div>
        </div>
      </main>
    </div>
  );
};

export default App;